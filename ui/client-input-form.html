<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pest Control Client Profile Creator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            color: #e2e8f0;
            margin: 0;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: #1e293b;
            color: #e2e8f0;
            padding: 20px;
            box-shadow: 2px 0 20px rgba(0,0,0,0.3);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            border-right: 1px solid #334155;
        }

        .sidebar h3 {
            margin: 0 0 20px 0;
            color: #f1f5f9;
            font-size: 1.2em;
            border-bottom: 2px solid #475569;
            padding-bottom: 10px;
            font-weight: 600;
        }

        .sidebar-section {
            margin-bottom: 25px;
        }

        .sidebar-link {
            display: block;
            color: #cbd5e1;
            text-decoration: none;
            padding: 12px 16px;
            margin: 6px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
            background: #334155;
            border: 1px solid #475569;
            font-weight: 500;
        }

        .sidebar-link:hover {
            background: #3b82f6;
            color: #f8fafc;
            text-decoration: none;
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .sidebar-link.disabled {
            background: #475569;
            color: #64748b;
            cursor: not-allowed;
            border-color: #64748b;
        }

        .sidebar-link.disabled:hover {
            transform: none;
            background: #475569;
            color: #64748b;
            box-shadow: none;
        }

        .drive-input-section {
            background: #334155;
            padding: 16px;
            border-radius: 10px;
            margin-top: 20px;
            border: 1px solid #475569;
        }

        .drive-input-section label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9em;
            color: #f1f5f9;
            font-weight: 600;
        }

        .drive-input-section input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #64748b;
            border-radius: 6px;
            font-size: 0.9em;
            background: #1e293b;
            color: #e2e8f0;
            transition: border-color 0.3s ease;
        }

        .drive-input-section input::placeholder {
            color: #94a3b8;
        }

        .drive-input-section input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .drive-help-text {
            font-size: 0.8em;
            color: #94a3b8;
            margin-top: 6px;
            line-height: 1.4;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 20px auto;
            background: #1e293b;
            border-radius: 16px;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            overflow: hidden;
            border: 1px solid #334155;
        }

        .header {
            background: linear-gradient(135deg, #0c1427 0%, #1a1f3a 50%, #0f172a 100%);
            color: #f8fafc;
            padding: 40px 32px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(120, 219, 226, 0.05) 0%, transparent 50%);
            opacity: 0.6;
        }

        .header::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.02) 2px,
                    rgba(255, 255, 255, 0.02) 4px
                ),
                repeating-linear-gradient(
                    0deg,
                    transparent,
                    transparent 2px,
                    rgba(255, 255, 255, 0.01) 2px,
                    rgba(255, 255, 255, 0.01) 4px
                );
            opacity: 0.8;
        }

        .header h1 {
            font-family: 'Orbitron', 'Inter', sans-serif;
            font-size: 3.2em;
            margin-bottom: 16px;
            text-shadow: 
                0 0 10px rgba(120, 119, 198, 0.5),
                0 0 20px rgba(120, 119, 198, 0.3),
                0 0 30px rgba(120, 119, 198, 0.2);
            font-weight: 900;
            letter-spacing: 2px;
            position: relative;
            z-index: 2;
            background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #cbd5e1 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-family: 'Rajdhani', 'Inter', sans-serif;
            font-size: 1.3em;
            font-weight: 500;
            letter-spacing: 1px;
            position: relative;
            z-index: 2;
            color: #94a3b8;
            text-transform: uppercase;
        }

        .progress-container {
            background: rgba(248,250,252,0.2);
            height: 6px;
            border-radius: 3px;
            margin-top: 24px;
            overflow: hidden;
        }

        .progress-bar {
            background: #fbbf24;
            height: 100%;
            width: 0%;
            transition: width 0.4s ease;
        }

        .form-container {
            padding: 40px;
            background: #1e293b;
        }

        .section {
            margin-bottom: 32px;
            border: 1px solid #475569;
            border-radius: 12px;
            overflow: hidden;
            background: #0f172a;
        }

        .section-header {
            background: #334155;
            padding: 18px 24px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
            border-bottom: 1px solid #475569;
        }

        .section-header:hover {
            background: #475569;
        }

        .section-header h2 {
            font-size: 1.4em;
            color: #f1f5f9;
            font-weight: 600;
        }

        .toggle-icon {
            font-size: 1.3em;
            transition: transform 0.3s ease;
            color: #94a3b8;
        }

        .section-content {
            padding: 28px;
            display: none;
            background: #0f172a;
        }

        .section-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 24px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #f1f5f9;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #475569;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #334155;
            color: #e2e8f0;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            background: #1e293b;
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: #94a3b8;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .service-item,
        .technician-item,
        .area-item {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            position: relative;
        }

        .service-item {
            border-left: 4px solid #10b981;
        }

        .technician-item {
            border-left: 4px solid #f59e0b;
        }

        .area-item {
            border-left: 4px solid #06b6d4;
        }

        .policy-subsection {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 28px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .policy-subsection h4 {
            margin: 0 0 20px 0;
            color: #f1f5f9;
            font-size: 1.3em;
            border-bottom: 2px solid #475569;
            padding-bottom: 12px;
            font-weight: 600;
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .item-title {
            font-weight: 700;
            font-size: 1.2em;
            color: #f1f5f9;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            font-family: inherit;
        }

        .btn-primary {
            background: #3b82f6;
            color: #f8fafc;
            border: 1px solid #2563eb;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-outline-secondary {
            background: transparent;
            color: #94a3b8;
            border: 1px solid #64748b;
        }

        .btn-outline-secondary:hover {
            background: #64748b;
            color: #f8fafc;
        }

        .btn-danger {
            background: #ef4444;
            color: #f8fafc;
            padding: 8px 16px;
            font-size: 12px;
            border: 1px solid #dc2626;
        }

        .btn-danger:hover {
            background: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }

        .btn-success {
            background: #10b981;
            color: #f8fafc;
            padding: 16px 32px;
            font-size: 1.1em;
            margin-top: 32px;
            width: 100%;
            border: 1px solid #059669;
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);
        }

        .service-details {
            background: #334155;
            padding: 20px;
            border-radius: 10px;
            margin-top: 16px;
            border: 1px solid #475569;
        }

        .service-details h4 {
            margin-bottom: 16px;
            color: #f1f5f9;
            font-weight: 600;
        }

        .inspection-text {
            background: #451a03;
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            border-left: 4px solid #f59e0b;
        }

        .help-text {
            font-size: 0.85em;
            color: #94a3b8;
            margin-top: 6px;
            font-style: italic;
        }

        .required {
            color: #ef4444;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 12px;
            margin-top: 12px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px 12px;
            border-radius: 8px;
            transition: background-color 0.3s ease;
            border: 1px solid #475569;
        }

        .checkbox-item:hover {
            background-color: #334155;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            margin-bottom: 0;
            transform: scale(1.2);
            accent-color: #3b82f6;
        }

        .checkbox-item label {
            margin-bottom: 0;
            cursor: pointer;
            color: #e2e8f0;
        }

        .service-variants-section {
            background: #334155;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border: 1px solid #475569;
        }

        .service-variants-section h4 {
            margin-bottom: 16px;
            color: #f1f5f9;
            font-size: 1.2em;
            font-weight: 600;
        }

        .variant-item {
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 16px;
            position: relative;
        }

        .service-accordion {
            border: 1px solid #475569;
            border-radius: 12px;
            margin-bottom: 20px;
            background: #1e293b;
        }

        .service-header {
            background: #334155;
            padding: 16px 20px;
            cursor: pointer;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s ease;
            border-bottom: 1px solid #475569;
        }

        .service-header:hover {
            background: #475569;
        }

        .service-title {
            font-weight: 600;
            color: #f1f5f9;
            margin: 0;
            font-size: 1.2em;
        }

        .service-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .collapse-indicator {
            color: #94a3b8;
            font-size: 1.2em;
            transition: transform 0.3s ease;
        }

        .service-content {
            padding: 24px;
            display: none;
            background: #1e293b;
        }

        .service-content.expanded {
            display: block;
        }

        .service-essentials {
            margin-bottom: 20px;
        }

        .advanced-details {
            margin-top: 20px;
        }

        .advanced-content {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #475569;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                box-shadow: none;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .form-row,
            .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .container {
                margin: 10px;
            }
            
            .header {
                padding: 20px;
            }
            
            .form-container {
                padding: 20px;
            }
        }

        .add-btn {
            width: 100%;
            margin-top: 15px;
        }

        .remove-btn {
            position: absolute;
            top: 15px;
            right: 15px;
        }

        /* Modern Address Section Styles */
        .address-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #3a4a5c;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
        }

        .address-section h4 {
            margin: 0 0 15px 0;
            color: #60a5fa;
            font-size: 1.1em;
            font-weight: 600;
        }

        /* Office Hours Styles */
        .office-hours-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #3a4a5c;
            border-radius: 8px;
            background: rgba(255,255,255,0.02);
        }

        .office-hours-section h4 {
            margin: 0 0 10px 0;
            color: #60a5fa;
            font-size: 1.1em;
            font-weight: 600;
        }

        .hours-instructions {
            margin: 0 0 15px 0;
            color: #94a3b8;
            font-size: 0.9em;
        }

        .hours-grid {
            display: grid;
            gap: 10px;
        }

        .day-hours {
            display: grid;
            grid-template-columns: 80px 30px 120px 30px 120px;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 6px;
        }

        .day-label {
            font-weight: 500;
            color: #e2e8f0;
            font-size: 0.9em;
        }

        .time-select {
            padding: 6px 8px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3748;
            color: #e2e8f0;
            font-size: 0.85em;
        }

        .time-select:disabled {
            opacity: 0.5;
            background: #1a202c;
        }

        .to-label {
            text-align: center;
            color: #94a3b8;
            font-size: 0.8em;
        }

        /* Service Areas Bulk Upload Styles */
        .service-areas-bulk {
            padding: 20px;
        }

        .bulk-input-methods {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-method {
            background: rgba(255,255,255,0.02);
            border: 1px solid #3a4a5c;
            border-radius: 8px;
            padding: 15px;
        }

        .input-method h4 {
            margin: 0 0 15px 0;
            color: #60a5fa;
            font-size: 1.1em;
        }

        .file-upload-section {
            position: relative;
        }

        .file-upload-label {
            display: block;
            padding: 20px;
            border: 2px dashed #4a5568;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.02);
        }

        .file-upload-label:hover {
            border-color: #60a5fa;
            background: rgba(96, 165, 250, 0.1);
        }

        .file-upload-label span {
            display: block;
            color: #60a5fa;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .file-upload-help {
            font-size: 0.85em;
            color: #94a3b8;
        }

        #zipCodeFile {
            display: none;
        }

        #zipCodePaste {
            width: 100%;
            min-height: 150px;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 6px;
            color: #e2e8f0;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }

        .parse-options {
            margin-top: 10px;
        }

        .parse-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #94a3b8;
            font-size: 0.9em;
            cursor: pointer;
        }

        .zip-preview-section {
            background: rgba(255,255,255,0.02);
            border: 1px solid #3a4a5c;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }

        .zip-preview-section h4 {
            margin: 0 0 15px 0;
            color: #60a5fa;
        }

        .zip-preview-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .zip-preview-controls .btn {
            padding: 6px 12px;
            font-size: 0.85em;
        }

        .zip-preview-list {
            max-height: 300px;
            overflow-y: auto;
            background: #1a202c;
            border: 1px solid #4a5568;
            border-radius: 6px;
            padding: 10px;
        }

        .zip-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            border-bottom: 1px solid #374151;
        }

        .zip-item:last-child {
            border-bottom: none;
        }

        .zip-code {
            font-weight: 600;
            color: #60a5fa;
        }

        .zip-city {
            color: #94a3b8;
        }

        @media (max-width: 768px) {
            .bulk-input-methods {
                grid-template-columns: 1fr;
            }
        }

        /* Searchable State Select Styles */
        .searchable-select-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .searchable-select-input {
            flex: 1;
            padding: 8px 30px 8px 10px;
            border: 1px solid #4a5568;
            border-radius: 4px;
            background: #2d3748;
            color: #e2e8f0;
            font-size: 0.9em;
        }

        .searchable-select-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .searchable-select-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #94a3b8;
            font-size: 0.8em;
            user-select: none;
            padding: 2px;
        }

        .searchable-select-arrow:hover {
            color: #60a5fa;
        }

        .searchable-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #2d3748;
            border: 1px solid #4a5568;
            border-top: none;
            border-radius: 0 0 4px 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .searchable-select-option {
            padding: 8px 10px;
            cursor: pointer;
            color: #e2e8f0;
            border-bottom: 1px solid #374151;
        }

        .searchable-select-option:last-child {
            border-bottom: none;
        }

        .searchable-select-option:hover {
            background: #374151;
            color: #60a5fa;
        }

        .searchable-select-option.selected {
            background: #3b82f6;
            color: white;
        }

        .no-results {
            padding: 8px 10px;
            color: #94a3b8;
            font-style: italic;
        }

        /* Progress Control Styles */
        .sidebar-section h4 {
            margin: 0 0 15px 0;
            color: #60a5fa;
            font-size: 1.1em;
            font-weight: 600;
        }

        .sidebar-btn {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: none;
            border-radius: 6px;
            background: #374151;
            color: #e2e8f0;
            font-size: 0.9em;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid #4b5563;
        }

        .sidebar-btn:hover {
            background: #4b5563;
            border-color: #60a5fa;
            color: #60a5fa;
        }

        .sidebar-btn:active {
            transform: translateY(1px);
        }

        .progress-status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.8em;
            text-align: center;
            transition: all 0.3s ease;
        }

        .progress-status.success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .progress-status.warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .progress-status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
    </style>
</head>
<body>
    <!-- Sidebar Navigation -->
    <div class="sidebar">
        <h3>üìä Quick Links</h3>
        
        <div class="sidebar-section">
            <a href="https://docs.google.com/spreadsheets/d/1WId_kg8Fu0dbnpWSSQQVv-GJJibaeSu7p23PEaeePec/edit" id="sidebarMasterSheetLink" class="sidebar-link" target="_blank">
                üìä Master Client Profiles Sheet
            </a>
            <a href="#" id="sidebarDriveLink" class="sidebar-link" target="_blank" style="display: none;">
                üìÅ Company Drive Folder
            </a>
        </div>

        <div class="sidebar-section">
            <h4>üíæ Progress Controls</h4>
            <button class="sidebar-btn" onclick="saveFormProgress()" title="Save current form data locally">
                üíæ Save Progress
            </button>
            <button class="sidebar-btn" onclick="loadFormProgress()" title="Load previously saved form data">
                üìÇ Load Progress
            </button>
            <button class="sidebar-btn" onclick="clearFormProgress()" title="Clear saved progress and reset form">
                üóëÔ∏è Clear Progress
            </button>
            <div class="progress-status" id="progressStatus">
                <!-- Status will appear here -->
            </div>
        </div>

        <div class="drive-input-section">
            <label for="sidebarGoogleDriveFolder">Company Drive Folder</label>
            <input type="url" id="sidebarGoogleDriveFolder" name="sidebarGoogleDriveFolder" 
                   placeholder="https://drive.google.com/drive/folders/..." 
                   onchange="updateDriveLink()">
            <div class="drive-help-text">
                Paste the Google Drive folder link for this company. This will be used to store copies of client information.
            </div>
        </div>

        <div class="sidebar-section">
            <h3>üìã Form Sections</h3>
            <a href="#office-section" class="sidebar-link" onclick="scrollToSection('office')">
                üè¢ Office Information
            </a>
            <a href="#services-section" class="sidebar-link" onclick="scrollToSection('services')">
                üõ°Ô∏è Services
            </a>
            <a href="#technicians-section" class="sidebar-link" onclick="scrollToSection('technicians')">
                üë®‚Äçüîß Technicians
            </a>
            <a href="#areas-section" class="sidebar-link" onclick="scrollToSection('areas')">
                üìç Service Areas
            </a>
            <a href="#policies-section" class="sidebar-link" onclick="scrollToSection('policies')">
                üìú Policies
            </a>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="container">
            <div class="header">
                <h1>üêõ Pest Control Client Profile</h1>
                <p>Create comprehensive client profiles for SOS Pest Control</p>
                
                <div class="progress-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
            </div>

            <div class="form-container">
                <form id="clientForm">
                    <!-- Hidden field for Google Drive folder (synced from sidebar) -->
                    <input type="hidden" id="googleDriveFolder" name="googleDriveFolder" value="">
                    
                    <!-- Office Information Section -->
                    <div class="section" id="office-section">
                        <div class="section-header" onclick="toggleSection('office')">
                            <h2>üè¢ Office Information</h2>
                            <span class="toggle-icon">‚ñº</span>
                        </div>
                    <div class="section-content active" id="office-content">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="companyName">Company Name <span class="required">*</span></label>
                                <input type="text" id="companyName" name="companyName" required placeholder="Enter company name">
                            </div>
                            <div class="form-group">
                                <!-- Empty for spacing - Google Drive folder moved to sidebar -->
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="website">Website</label>
                                <input type="url" id="website" name="website" placeholder="pest-sos.com" onblur="formatURL(this)">
                                <div class="help-text">Enter domain only (e.g., pest-sos.com) - https:// will be added automatically</div>
                            </div>
                            <div class="form-group">
                                <label for="locations">Location(s)</label>
                                <input type="text" id="locations" name="locations" placeholder="City, State">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="timezone">Timezone</label>
                                <select id="timezone" name="timezone" onchange="toggleCustomInput(this, 'timezoneCustom')">
                                    <option value="">Select Timezone</option>
                                    <option value="EST">Eastern Standard Time (EST)</option>
                                    <option value="CST">Central Standard Time (CST)</option>
                                    <option value="MST">Mountain Standard Time (MST)</option>
                                    <option value="PST">Pacific Standard Time (PST)</option>
                                    <option value="AKST">Alaska Standard Time (AKST)</option>
                                    <option value="HST">Hawaii Standard Time (HST)</option>
                                    <option value="Custom">Custom Timezone</option>
                                </select>
                                <input type="text" id="timezoneCustom" name="timezoneCustom" placeholder="Enter custom timezone..." style="display: none; margin-top: 8px;">
                            </div>
                            <div class="form-group">
                                <!-- Empty for spacing -->
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="officePhone">Office Phone <span class="required">*</span></label>
                                <input type="tel" id="officePhone" name="officePhone" required placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label for="customerContactEmail">Customer Contact Email <span class="required">*</span></label>
                                <input type="email" id="customerContactEmail" name="customerContactEmail" required placeholder="contact@company.com">
                            </div>
                        </div>
                        
                        <!-- Modern Address Section -->
                        <div class="address-section">
                            <h4>Physical Address</h4>
                            <div class="form-row">
                        <div class="form-group">
                                    <label for="physicalStreet">Street Address</label>
                                    <input type="text" id="physicalStreet" name="physicalStreet" placeholder="123 Main Street">
                                </div>
                                <div class="form-group">
                                    <label for="physicalSuite">Suite/Unit</label>
                                    <input type="text" id="physicalSuite" name="physicalSuite" placeholder="Suite 100">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="physicalCity">City</label>
                                    <input type="text" id="physicalCity" name="physicalCity" placeholder="Dallas">
                                </div>
                                <div class="form-group">
                                    <label for="physicalState">State</label>
                                    <div class="searchable-select-container">
                                        <input type="text" id="physicalState" name="physicalState" class="searchable-select-input" placeholder="Type to search states..." autocomplete="off" onclick="showStateDropdown('physicalState')" oninput="filterStates('physicalState')">
                                        <div class="searchable-select-arrow" onclick="toggleStateDropdown('physicalState')">‚ñº</div>
                                        <div class="searchable-select-dropdown" id="physicalStateDropdown" style="display: none;">
                                            <!-- States will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="physicalZip">ZIP Code</label>
                                    <input type="text" id="physicalZip" name="physicalZip" placeholder="75201" pattern="[0-9]{5}(-[0-9]{4})?">
                                </div>
                            </div>
                        </div>
                        
                        <div class="address-section">
                            <h4>Mailing Address</h4>
                        <div class="form-group">
                                <label>
                                    <input type="checkbox" id="sameAsPhysical" name="sameAsPhysical" onchange="copyPhysicalAddress()">
                                    Same as Physical Address
                                </label>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mailingStreet">Street Address</label>
                                    <input type="text" id="mailingStreet" name="mailingStreet" placeholder="P.O. Box 123">
                                </div>
                                <div class="form-group">
                                    <label for="mailingSuite">Suite/Unit</label>
                                    <input type="text" id="mailingSuite" name="mailingSuite" placeholder="Suite 100">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="mailingCity">City</label>
                                    <input type="text" id="mailingCity" name="mailingCity" placeholder="Dallas">
                                </div>
                                <div class="form-group">
                                    <label for="mailingState">State</label>
                                    <div class="searchable-select-container">
                                        <input type="text" id="mailingState" name="mailingState" class="searchable-select-input" placeholder="Type to search states..." autocomplete="off" onclick="showStateDropdown('mailingState')" oninput="filterStates('mailingState')">
                                        <div class="searchable-select-arrow" onclick="toggleStateDropdown('mailingState')">‚ñº</div>
                                        <div class="searchable-select-dropdown" id="mailingStateDropdown" style="display: none;">
                                            <!-- States will be populated by JavaScript -->
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="mailingZip">ZIP Code</label>
                                    <input type="text" id="mailingZip" name="mailingZip" placeholder="75201" pattern="[0-9]{5}(-[0-9]{4})?">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Modern Office Hours Section -->
                        <div class="office-hours-section">
                            <h4>Office Hours</h4>
                            <p class="hours-instructions">Check the days you're open and select start/end times:</p>
                            <div class="hours-grid" id="hoursGrid">
                                <!-- Hours will be generated by JavaScript -->
                            </div>
                            <input type="hidden" id="officeHours" name="officeHours" value="">
                        </div>
                        
                        <div class="form-group">
                            <label for="bulletin">Bulletin/Notes</label>
                            <textarea id="bulletin" name="bulletin" rows="3" placeholder="Any special notes or announcements for this client..."></textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="pestsNotCovered">Pests Not Covered</label>
                            <textarea id="pestsNotCovered" name="pestsNotCovered" rows="2" placeholder="List pests not covered (e.g., Carpenter Ants, Bed Bugs)"></textarea>
                        </div>

                        <div class="form-group">
                            <label>Holidays Observed</label>
                            <div class="checkbox-grid">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="newYearsEve" name="holidays" value="New Year's Eve">
                                    <label for="newYearsEve">New Year's Eve</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="newYearsDay" name="holidays" value="New Year's Day">
                                    <label for="newYearsDay">New Year's Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="martinLutherKing" name="holidays" value="Martin Luther King Jr. Day">
                                    <label for="martinLutherKing">Martin Luther King Jr. Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="presidentsDay" name="holidays" value="President's Day">
                                    <label for="presidentsDay">President's Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="memorialDay" name="holidays" value="Memorial Day">
                                    <label for="memorialDay">Memorial Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="independenceDay" name="holidays" value="Independence Day">
                                    <label for="independenceDay">Independence Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="juneteenth" name="holidays" value="Juneteenth">
                                    <label for="juneteenth">Juneteenth</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="laborDay" name="holidays" value="Labor Day">
                                    <label for="laborDay">Labor Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="columbusDay" name="holidays" value="Columbus/Indigenous People's Day">
                                    <label for="columbusDay">Columbus/Indigenous People's Day</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="thanksgiving" name="holidays" value="Thanksgiving">
                                    <label for="thanksgiving">Thanksgiving</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="blackFriday" name="holidays" value="Black Friday">
                                    <label for="blackFriday">Black Friday</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="christmasEve" name="holidays" value="Christmas Eve">
                                    <label for="christmasEve">Christmas Eve</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="christmasDay" name="holidays" value="Christmas Day">
                                    <label for="christmasDay">Christmas Day</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="fieldRoutesLink">FieldRoutes Link</label>
                                <input type="url" id="fieldRoutesLink" name="fieldRoutesLink" placeholder="app.fieldroutes.com/company123" onblur="formatURL(this)">
                                <div class="help-text">Enter domain/path only - https:// will be added automatically</div>
                            </div>
                            <div class="form-group">
                                <!-- Empty for spacing -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Services Section -->
                <div class="section" id="services-section">
                    <div class="section-header" onclick="toggleSection('services')">
                        <h2>üõ°Ô∏è Services</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="services-content">
                        <div id="services-container">
                            <!-- Services will be added here -->
                        </div>
                        <button type="button" class="btn btn-primary add-btn" onclick="addService()">+ Add Service</button>
                    </div>
                </div>

                <!-- Technicians Section -->
                <div class="section" id="technicians-section">
                    <div class="section-header" onclick="toggleSection('technicians')">
                        <h2>üë®‚Äçüîß Technicians</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="technicians-content">
                        <div id="technicians-container">
                            <!-- Technicians will be added here -->
                        </div>
                        <button type="button" class="btn btn-primary add-btn" onclick="addTechnician()">+ Add Technician</button>
                    </div>
                </div>

                <!-- Service Areas Section -->
                <div class="section" id="areas-section">
                    <div class="section-header" onclick="toggleSection('areas')">
                        <h2>üìç Service Areas</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="areas-content">
                        <div class="service-areas-bulk">
                            <div class="bulk-input-methods">
                                <div class="input-method">
                                    <h4>üìÅ Option 1: Upload CSV File</h4>
                                    <div class="file-upload-section">
                                        <input type="file" id="zipCodeFile" accept=".csv,.txt" onchange="handleFileUpload(this)">
                                        <label for="zipCodeFile" class="file-upload-label">
                                            <span>üìé Choose CSV File</span>
                                            <div class="file-upload-help">Expected format: ZIP Code, City Name</div>
                                        </label>
                        </div>
                                </div>
                                
                                <div class="input-method">
                                    <h4>üìã Option 2: Copy & Paste from CSV</h4>
                                    <textarea id="zipCodePaste" placeholder="Paste your ZIP codes here...&#10;&#10;Expected formats:&#10;75201, Dallas&#10;75202, Dallas&#10;90210, Beverly Hills&#10;&#10;Or just ZIP codes (city will be auto-resolved):&#10;75201&#10;75202&#10;90210" rows="8" oninput="parseZipCodeInput(this)"></textarea>
                                    <div class="parse-options">
                                        <label>
                                            <input type="checkbox" id="autoResolveCity" checked> Auto-resolve city names for ZIP-only entries
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="zip-preview-section" id="zipPreviewSection" style="display: none;">
                                <h4>üìã Preview - Service Areas (Total: <span id="zipCount">0</span>)</h4>
                                <div class="zip-preview-controls">
                                    <button type="button" class="btn btn-sm btn-success" onclick="approveZipCodes()">‚úÖ Approve All</button>
                                    <button type="button" class="btn btn-sm btn-warning" onclick="editZipCodes()">‚úèÔ∏è Edit</button>
                                    <button type="button" class="btn btn-sm btn-danger" onclick="clearZipCodes()">üóëÔ∏è Clear</button>
                                </div>
                                <div class="zip-preview-list" id="zipPreviewList">
                                    <!-- Parsed ZIP codes will appear here -->
                                </div>
                            </div>
                            
                            <!-- Hidden input to store final ZIP code data -->
                            <input type="hidden" id="serviceAreasData" name="serviceAreasData" value="">
                        </div>
                    </div>
                </div>

                <!-- Policies Section -->
                <div class="section" id="policies-section">
                    <div class="section-header" onclick="toggleSection('policies')">
                        <h2>üìú Wix CMS Policies Configuration</h2>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="section-content" id="policies-content">
                        
                        <!-- Service Coverage Policies -->
                        <div class="policy-subsection">
                            <h4>üè¢ Service Coverage</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="treatVehicles">Do we treat vehicles?</label>
                                    <select id="treatVehicles" name="treatVehicles" onchange="toggleCustomInput(this, 'treatVehiclesCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Yes, Recreational Vehicles only">Yes, Recreational Vehicles only</option>
                                        <option value="Limited, refer to home office">Limited, refer to home office</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="treatVehiclesCustom" name="treatVehiclesCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="commercialProperties">Commercial Properties</label>
                                    <select id="commercialProperties" name="commercialProperties" onchange="toggleCustomInput(this, 'commercialPropertiesCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Yes, Requires Client follow-up">Yes, Requires Client follow-up</option>
                                        <option value="Yes, create lead and refer to home office">Yes, create lead and refer to home office</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="commercialPropertiesCustom" name="commercialPropertiesCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="multiFamilyOffered">Multi-Family Offered</label>
                                    <select id="multiFamilyOffered" name="multiFamilyOffered" onchange="toggleCustomInput(this, 'multiFamilyOfferedCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Yes, Requires Client Follow-up">Yes, Requires Client Follow-up</option>
                                        <option value="Yes, individual units only">Yes, individual units only</option>
                                        <option value="Yes, privately owned townhomes and condos">Yes, privately owned townhomes and condos</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="multiFamilyOfferedCustom" name="multiFamilyOfferedCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="trailersOffered">Trailers/Mobile Homes</label>
                                    <select id="trailersOffered" name="trailersOffered" onchange="toggleCustomInput(this, 'trailersOfferedCustom')">
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="Limited, create lead and refer to home office">Limited, create lead and refer to home office</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="trailersOfferedCustom" name="trailersOfferedCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                            </div>
                        </div>

                        <!-- Scheduling & Operations -->
                        <div class="policy-subsection">
                            <h4>‚è∞ Scheduling & Operations</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="signedContract">Signed Contract</label>
                                    <select id="signedContract" name="signedContract" onchange="toggleCustomInput(this, 'signedContractCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="None">None</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="signedContractCustom" name="signedContractCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="returningCustomers">Returning Customers</label>
                                    <input type="text" id="returningCustomers" name="returningCustomers" placeholder="e.g., None, Special pricing">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="appointmentConfirmations">Appointment Confirmations</label>
                                    <select id="appointmentConfirmations" name="appointmentConfirmations" onchange="toggleCustomInput(this, 'appointmentConfirmationsCustom')">
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="Confirm all appointments">Confirm all appointments</option>
                                        <option value="Do not confirm appointments">Do not confirm appointments</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="appointmentConfirmationsCustom" name="appointmentConfirmationsCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="callAhead">Call Ahead</label>
                                    <input type="text" id="callAhead" name="callAhead" placeholder="e.g., Yes, 30 minutes if requested">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="maxDistance">Max Distance</label>
                                    <input type="text" id="maxDistance" name="maxDistance" placeholder="e.g., 10 miles" value="10 miles">
                                </div>
                                <div class="form-group">
                                    <label for="schedulingPolicyTimes">Scheduling Policy Times</label>
                                    <textarea id="schedulingPolicyTimes" name="schedulingPolicyTimes" rows="2" placeholder="e.g., Inspection: AM/PM, Initial: 2 hour windows, Regular: AT"></textarea>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="sameDayServices">Same Day Services</label>
                                    <select id="sameDayServices" name="sameDayServices" onchange="toggleCustomInput(this, 'sameDayServicesCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes, refer to home office">Yes, refer to home office</option>
                                        <option value="Yes, before noon">Yes, before noon</option>
                                        <option value="Varies, Refer to home office">Varies, Refer to home office</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="sameDayServicesCustom" name="sameDayServicesCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="techSkilling">Tech Skilling</label>
                                    <select id="techSkilling" name="techSkilling" onchange="toggleCustomInput(this, 'techSkillingCustom')">
                                        <option value="Not standard">Not standard</option>
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="techSkillingCustom" name="techSkillingCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="afterHoursEmergency">After Hours Emergency</label>
                                <select id="afterHoursEmergency" name="afterHoursEmergency" onchange="toggleCustomInput(this, 'afterHoursEmergencyCustom')">
                                    <option value="No">No</option>
                                    <option value="Yes">Yes</option>
                                    <option value="Yes, send a home office ticket">Yes, send a home office ticket</option>
                                    <option value="Custom">Custom</option>
                                </select>
                                <input type="text" id="afterHoursEmergencyCustom" name="afterHoursEmergencyCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                            </div>
                        </div>

                        <!-- Service Policies -->
                        <div class="policy-subsection">
                            <h4>üîÑ Service Policies</h4>
                            <div class="form-group">
                                <label for="reservices">Reservices</label>
                                <textarea id="reservices" name="reservices" rows="3" placeholder="e.g., Customers must allow 10-14 days from prior service..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="setServiceTypeTo">Set Service Type To</label>
                                    <select id="setServiceTypeTo" name="setServiceTypeTo" onchange="toggleCustomInput(this, 'setServiceTypeToCustom')">
                                        <option value="Reservice">Reservice</option>
                                        <option value="Call Back Pest Control">Call Back Pest Control</option>
                                        <option value="Follow Up Service">Follow Up Service</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="setServiceTypeToCustom" name="setServiceTypeToCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="setSubscriptionTypeTo">Set Subscription Type To</label>
                                    <input type="text" id="setSubscriptionTypeTo" name="setSubscriptionTypeTo" value="Stand-Alone Service or Reservice" placeholder="Default subscription handling">
                                </div>
                            </div>
                        </div>

                        <!-- Payment & Financial -->
                        <div class="policy-subsection">
                            <h4>üí≥ Payment & Financial</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="paymentPlans">Payment Plans</label>
                                    <select id="paymentPlans" name="paymentPlans" onchange="toggleCustomInput(this, 'paymentPlansCustom')">
                                        <option value="No">No</option>
                                        <option value="Yes, refer to Home Office">Yes, refer to Home Office</option>
                                        <option value="Offered">Offered</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="paymentPlansCustom" name="paymentPlansCustom" placeholder="Enter custom response..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label for="paymentTypes">Payment Types</label>
                                    <input type="text" id="paymentTypes" name="paymentTypes" value="Cash, Check, Card, ACH" placeholder="Accepted payment methods">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="pastDuePeriod">Past Due Period</label>
                                    <input type="text" id="pastDuePeriod" name="pastDuePeriod" value="30 days" placeholder="e.g., 30 days, 90 days">
                                </div>
                                <div class="form-group">
                                    <label for="toolsToSave">Tools To Save</label>
                                    <textarea id="toolsToSave" name="toolsToSave" rows="2" placeholder="e.g., Free reservice, manager visit, $50 coupon"></textarea>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="cancellationPolicy">Cancellation Policy</label>
                                <textarea id="cancellationPolicy" name="cancellationPolicy" rows="3" placeholder="Cancellation terms and fees"></textarea>
                            </div>
                        </div>

                        <!-- Additional Information -->
                        <div class="policy-subsection">
                            <h4>üìù Additional Information</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="additionalNotes">Additional Notes</label>
                                    <textarea id="additionalNotes" name="additionalNotes" rows="3" placeholder="Special instructions or notes"></textarea>
                                </div>
                                <div class="form-group">
                                    <label for="branch">Branch</label>
                                    <input type="text" id="branch" name="branch" placeholder="Branch/location identifier">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-success" id="submitButton">Save Client Profile</button>
            </form>
        </div>
    </div>
</div>

    <script>
        let serviceCounter = 0;
        let technicianCounter = 0;
        let areaCounter = 0;

        // Sidebar navigation functions
        function scrollToSection(sectionId) {
            const element = document.getElementById(sectionId + '-section');
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
                // Expand the section if it's collapsed
                const content = document.getElementById(sectionId + '-content');
                if (content && !content.classList.contains('active')) {
                    toggleSection(sectionId);
                }
            }
        }

        function updateDriveLink() {
            const driveUrl = document.getElementById('sidebarGoogleDriveFolder').value;
            const driveLink = document.getElementById('sidebarDriveLink');
            
            if (driveUrl && driveUrl.trim()) {
                driveLink.href = driveUrl;
                driveLink.style.display = 'block'; // Show the link
                driveLink.classList.remove('disabled');
                
                // Generate Profile_ID and pre-create sheet structure
                initializeProfileStructure(driveUrl);
            } else {
                driveLink.style.display = 'none'; // Hide the link
                driveLink.classList.add('disabled');
                driveLink.href = '#';
            }
            
            // Also update the form field for submission
            document.getElementById('googleDriveFolder').value = driveUrl;
        }

        // Initialize Profile structure when Drive folder is set
        function initializeProfileStructure(driveUrl) {
            // Check if we're in edit mode - don't create new Profile_ID
            const urlParams = new URLSearchParams(window.location.search);
            const isEditMode = urlParams.get('edit') === 'true';
            
            if (isEditMode) {
                console.log('In edit mode - skipping Profile_ID generation');
                return;
            }
            
            // Check if we already have a Profile_ID for this session
            let currentProfileId = sessionStorage.getItem('currentProfileId');
            
            if (!currentProfileId) {
                // Generate new Profile_ID only for new profiles
                currentProfileId = 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('currentProfileId', currentProfileId);
                
                // Show the generated Profile_ID to user
                showProgressStatus(`üÜî Profile ID generated: ${currentProfileId}`, 'success');
                
                // Pre-create sheet structure
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Profile structure initialized:', result);
                        showProgressStatus('‚úÖ Profile structure ready', 'success');
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error initializing profile:', error);
                        showProgressStatus('‚ùå Error initializing profile', 'error');
                    })
                    .initializeProfileStructure(currentProfileId, driveUrl);
            }
        }

        // Toggle custom input fields for dropdowns
        function toggleCustomInput(selectElement, customInputId) {
            // Handle both direct IDs and template literals
            let actualCustomInputId = customInputId;
            
            // If the ID contains ${}, try to find the actual element by searching for similar IDs
            if (customInputId.includes('${')) {
                // Find the parent element and look for the custom input within it
                const parentContainer = selectElement.closest('.form-group') || selectElement.closest('.service-item') || selectElement.closest('.technician-item');
                if (parentContainer) {
                    const customInput = parentContainer.querySelector('input[id*="custom"]');
                    if (customInput) {
                        actualCustomInputId = customInput.id;
                    }
                }
            }
            
            const customInput = document.getElementById(actualCustomInputId);
            if (customInput) {
            if (selectElement.value === 'Custom') {
                customInput.style.display = 'block';
                customInput.required = true;
                    customInput.focus(); // Focus the input for immediate typing
            } else {
                customInput.style.display = 'none';
                customInput.required = false;
                customInput.value = '';
            }
            } else {
                // Fallback: create a custom input dynamically if it doesn't exist
                if (selectElement.value === 'Custom') {
                    createDynamicCustomInput(selectElement, customInputId);
                }
            }
        }
        
        // Create a custom input dynamically if it doesn't exist
        function createDynamicCustomInput(selectElement, baseId) {
            const existingInput = selectElement.parentElement.querySelector('.dynamic-custom-input');
            if (existingInput) {
                existingInput.style.display = 'block';
                existingInput.focus();
                return;
            }
            
            const customInput = document.createElement('input');
            customInput.type = 'text';
            customInput.className = 'dynamic-custom-input';
            customInput.placeholder = 'Enter custom value...';
            customInput.style.cssText = 'width: 100%; margin-top: 8px; padding: 8px; border: 1px solid #4a5568; border-radius: 4px; background: #2d3748; color: #e2e8f0;';
            customInput.name = selectElement.name.replace(']', 'Custom]');
            
            selectElement.parentElement.appendChild(customInput);
            customInput.focus();
        }

        // Toggle service accordion
        function toggleServiceAccordion(header) {
            const content = header.nextElementSibling;
            const indicator = header.querySelector('.collapse-indicator');
            
            if (content.classList.contains('expanded')) {
                content.classList.remove('expanded');
                indicator.textContent = '‚ñ∂';
            } else {
                content.classList.add('expanded');
                indicator.textContent = '‚ñº';
            }
        }

        // Toggle advanced details within a service
        function toggleAdvancedDetails(serviceIndex) {
            const content = document.getElementById(`advanced-content-${serviceIndex}`);
            const toggle = document.getElementById(`advanced-toggle-${serviceIndex}`);
            
            if (content.style.display === 'none') {
                content.style.display = 'block';
                toggle.textContent = 'Hide Advanced Details ‚ñ≤';
            } else {
                content.style.display = 'none';
                toggle.textContent = 'Show Advanced Details ‚ñº';
            }
        }

        // Update service title when name changes
        function updateServiceTitle(nameInput, serviceIndex) {
            const title = nameInput.closest('.service-item').querySelector('.service-title');
            const serviceName = nameInput.value || 'New Service';
            title.textContent = `Service #${serviceIndex} - ${serviceName}`;
        }

        // Toggle service details section on/off
        function toggleServiceDetailsSection(selectElement, serviceIndex) {
            const serviceDetails = document.getElementById(`service-details-${serviceIndex}`);
            if (selectElement.value === 'Yes') {
                serviceDetails.style.display = 'block';
            } else {
                serviceDetails.style.display = 'none';
            }
        }

        // Toggle variant service details section on/off
        function toggleVariantServiceDetails(selectElement, serviceIndex, variantIndex) {
            const serviceDetails = document.getElementById(`variant-details-${serviceIndex}-${variantIndex}`);
            if (selectElement.value === 'Yes') {
                serviceDetails.style.display = 'block';
            } else {
                serviceDetails.style.display = 'none';
            }
        }

        // Toggle section visibility
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId + '-content');
            const icon = content.parentElement.querySelector('.toggle-icon');
            
            if (content.classList.contains('active')) {
                content.classList.remove('active');
                icon.textContent = '‚ñ∂';
            } else {
                content.classList.add('active');
                icon.textContent = '‚ñº';
            }
        }

        // Update service type behavior
        function updateServiceType(selectElement, serviceIndex) {
            const serviceType = selectElement.value;
            const serviceDetails = document.getElementById(`service-details-${serviceIndex}`);
            const inspectionText = document.getElementById(`inspection-text-${serviceIndex}`);
            
            if (serviceType === 'inspection') {
                serviceDetails.style.display = 'none';
                inspectionText.style.display = 'block';
                
                // Update agent instructions based on inspection type
                const typeSelect = selectElement.parentElement.parentElement.querySelector('select[name*="[type]"]');
                updateInspectionText(typeSelect, serviceIndex);
            } else if (serviceType === 'refer-office') {
                serviceDetails.style.display = 'none';
                inspectionText.style.display = 'block';
                const textarea = inspectionText.querySelector('textarea');
                textarea.value = 'Please refer this service to the home office for specialized handling.';
            } else {
                serviceDetails.style.display = 'block';
                inspectionText.style.display = 'none';
            }
        }

        function toggleServiceDetails(selectElement, serviceIndex) {
            const inspectionType = selectElement.value;
            const inspectionText = document.getElementById(`inspection-text-${serviceIndex}`);
            
            if (inspectionType === 'free-inspection') {
                inspectionText.style.display = 'block';
                const textarea = inspectionText.querySelector('textarea');
                textarea.value = 'Set up and schedule Free Inspection';
            } else if (inspectionType === 'paid-inspection') {
                inspectionText.style.display = 'block';
                const textarea = inspectionText.querySelector('textarea');
                textarea.value = 'Set up and Schedule Paid Inspection';
            }
        }

        function updateInspectionText(selectElement, serviceIndex) {
            const inspectionType = selectElement.value;
            const inspectionText = document.getElementById(`inspection-text-${serviceIndex}`);
            const textarea = inspectionText.querySelector('textarea');
            
            if (inspectionType === 'free-inspection') {
                textarea.value = 'Set up and schedule Free Inspection';
            } else if (inspectionType === 'paid-inspection') {
                textarea.value = 'Set up and Schedule Paid Inspection';
            }
        }

        // Add service function
        function addService() {
            serviceCounter++;
            const container = document.getElementById('services-container');
            
            const serviceDiv = document.createElement('div');
            serviceDiv.className = 'service-item service-accordion';
            serviceDiv.innerHTML = `
                <div class="service-header" onclick="toggleServiceAccordion(this)">
                    <h3 class="service-title">Service #${serviceCounter} - New Service</h3>
                    <div class="service-actions">
                        <span class="collapse-indicator">‚ñº</span>
                        <button type="button" class="btn btn-danger btn-sm" onclick="event.stopPropagation(); removeService(this)">Remove</button>
                    </div>
                </div>
                
                <div class="service-content expanded">
                    <!-- Essential Fields (Always Visible) -->
                    <div class="service-essentials">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Service Name:</label>
                                <input type="text" name="services[${serviceCounter}][name]" placeholder="e.g., General Pest Control" onchange="updateServiceTitle(this, ${serviceCounter})">
                            </div>
                            <div class="form-group">
                                <label>Service Category:</label>
                                <select name="services[${serviceCounter}][category]" onchange="updateServiceType(this, ${serviceCounter}); toggleCustomInput(this, 'serviceCategory_${serviceCounter}_custom')">
                                    <option value="standard">Standard Services</option>
                                    <option value="specialty">Specialty Services</option>
                                    <option value="termite">Termite Services</option>
                                    <option value="inspection">Inspection Services</option>
                                    <option value="Custom">Custom Category</option>
                                </select>
                                <input type="text" id="serviceCategory_${serviceCounter}_custom" name="services[${serviceCounter}][categoryCustom]" placeholder="Enter custom category..." style="display: none; margin-top: 8px;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Service Type:</label>
                                <select name="services[${serviceCounter}][type]" onchange="toggleServiceDetails(this, ${serviceCounter}); toggleCustomInput(this, 'serviceType_${serviceCounter}_custom')">
                                    <option value="recurring">Recurring Service</option>
                                    <option value="one-time">One Time Service</option>
                                    <option value="free-inspection">Free Inspection</option>
                                    <option value="paid-inspection">Paid Inspection</option>
                                    <option value="refer-office">Refer to Home Office</option>
                                    <option value="Custom">Custom Service Type</option>
                                </select>
                                <input type="text" id="serviceType_${serviceCounter}_custom" name="services[${serviceCounter}][typeCustom]" placeholder="Enter custom service type..." style="display: none; margin-top: 8px;">
                            </div>
                            <div class="form-group">
                                <label>Frequency:</label>
                                <select name="services[${serviceCounter}][frequency]" onchange="toggleCustomInput(this, 'serviceFrequency_${serviceCounter}_custom')">
                                    <option value="one-time">One Time</option>
                                    <option value="bi-monthly">Bi-Monthly</option>
                                    <option value="quarterly">Quarterly</option>
                                    <option value="monthly">Monthly</option>
                                    <option value="21-days">Every 21 Days</option>
                                    <option value="14-days">Every 14 Days</option>
                                    <option value="10-14-days">Every 10-14 Days</option>
                                    <option value="Custom">Custom Frequency</option>
                                </select>
                                <input type="text" id="serviceFrequency_${serviceCounter}_custom" name="services[${serviceCounter}][frequencyCustom]" placeholder="Enter custom frequency..." style="display: none; margin-top: 8px;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Description:</label>
                                <textarea name="services[${serviceCounter}][description]" rows="2" placeholder="Brief service description..."></textarea>
                            </div>
                        </div>

                        <!-- Pests Covered (Above Pricing) -->
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Pests Covered:</label>
                                <textarea name="services[${serviceCounter}][pests]" rows="2" placeholder="List pests covered by this service..."></textarea>
                            </div>
                        </div>


                        <!-- Note to Agent Section (Always Visible) -->
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Note to Agent (Optional):</label>
                                <textarea name="services[${serviceCounter}][noteToAgent]" rows="2" placeholder="Special instructions or notes for agents..." style="background: #451a03; border-left: 4px solid #f59e0b;"></textarea>
                                <div class="help-text">This will appear as "Note to Agent:" on the client profile</div>
                            </div>
                        </div>

                        <!-- Service Details Section with Toggle (Always Visible) -->
                        <div class="form-row">
                            <div class="form-group">
                                <label>Service Details:</label>
                                <select name="services[${serviceCounter}][hasDetails]" onchange="toggleServiceDetailsSection(this, ${serviceCounter})">
                                    <option value="Yes" selected>Yes</option>
                                    <option value="None">None</option>
                                </select>
                            </div>
                        </div>

                        <div class="service-details" id="service-details-${serviceCounter}" style="display: block;">
                            <h4>Service Details</h4>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Contract:</label>
                                    <input type="text" name="services[${serviceCounter}][contract]" placeholder="e.g., None, 1 Year">
                                </div>
                                <div class="form-group">
                                    <label>Guarantee:</label>
                                    <input type="text" name="services[${serviceCounter}][guarantee]" placeholder="e.g., None, Unlimited Reservices">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Call Ahead:</label>
                                    <select name="services[${serviceCounter}][callAhead]" onchange="toggleCustomInput(this, 'callAhead_${serviceCounter}_custom')">
                                        <option value="Yes">Yes</option>
                                        <option value="No">No</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="callAhead_${serviceCounter}_custom" name="services[${serviceCounter}][callAheadCustom]" placeholder="Enter custom call ahead policy..." style="display: none; margin-top: 8px;">
                                </div>
                                <div class="form-group">
                                    <label>Initial Duration:</label>
                                    <input type="text" name="services[${serviceCounter}][initialDuration]" placeholder="e.g., 30 Minutes">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Recurring Duration:</label>
                                    <input type="text" name="services[${serviceCounter}][recurringDuration]" placeholder="e.g., 30 Minutes, N/A">
                                </div>
                                <div class="form-group">
                                    <label>Leave During Service:</label>
                                    <select name="services[${serviceCounter}][leaveDuringService]" onchange="toggleCustomInput(this, 'leaveDuringService_${serviceCounter}_custom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="leaveDuringService_${serviceCounter}_custom" name="services[${serviceCounter}][leaveDuringServiceCustom]" placeholder="Enter custom leave policy..." style="display: none; margin-top: 8px;">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Follow Up:</label>
                                    <input type="text" name="services[${serviceCounter}][followUp]" placeholder="e.g., No, 14 Days, Every 10-14 Days">
                                </div>
                                <div class="form-group">
                                    <label>Prep Sheet:</label>
                                    <select name="services[${serviceCounter}][prepSheet]" onchange="toggleCustomInput(this, 'prepSheet_${serviceCounter}_custom')">
                                        <option value="No">No</option>
                                        <option value="Yes">Yes</option>
                                        <option value="Refer to Home Office">Refer to Home Office</option>
                                        <option value="Custom">Custom</option>
                                    </select>
                                    <input type="text" id="prepSheet_${serviceCounter}_custom" name="services[${serviceCounter}][prepSheetCustom]" placeholder="Enter custom prep sheet instructions..." style="display: none; margin-top: 8px;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Details (Collapsible) -->
                    <div class="advanced-details">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="toggleAdvancedDetails(${serviceCounter})" style="margin: 15px 0;">
                            <span id="advanced-toggle-${serviceCounter}">Show Advanced Details ‚ñº</span>
                        </button>
                        
                        <div id="advanced-content-${serviceCounter}" class="advanced-content" style="display: none;">
                            <!-- Service Variants Section -->
                            <div class="service-variants-section">
                                <h4>Service Variants/Options</h4>
                                <div class="help-text">Add different variants of this service (e.g., Standard, Premium, with Mosquito, etc.)</div>
                                <div id="variants-container-${serviceCounter}">
                                    <!-- Service variants will be added here -->
                                </div>
                                <button type="button" class="btn btn-primary btn-sm" onclick="addServiceVariant(${serviceCounter})">+ Add Variant</button>
                            </div>
                        </div>
                    </div>

                    <!-- Pricing Section - Moved to END as requested -->
                    <div class="service-pricing-section" style="background: #334155; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #475569;">
                        <h4 style="margin-bottom: 16px; color: #f1f5f9; font-size: 1.2em; font-weight: 600;">üí∞ Pricing Information</h4>
                        <div class="help-text" style="color: #cbd5e1; margin-bottom: 15px;">Fill out pricing last - after all service details are complete.</div>
                        
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Service Type:</label>
                                <input type="text" name="services[${serviceCounter}][serviceTypeDesc]" placeholder="e.g., Monthly Subscription / Pest Control">
                            </div>
                        </div>
                        
                        <!-- Pricing tiers container -->
                        <div id="pricingTiers_${serviceCounter}" style="background: #475569; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #334155;">
                            <div class="pricing-tiers-list"></div>
                        </div>
                        <div class="help-text" style="color: #cbd5e1;">Define multiple square-footage tiers: min/max, first and recurring prices.</div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Product Type:</label>
                                <input type="text" name="services[${serviceCounter}][productType]" placeholder="e.g., Pest Control, Termite">
                            </div>
                            <div class="form-group">
                                <label>Sold-As Name:</label>
                                <input type="text" name="services[${serviceCounter}][soldAsName]" placeholder="Name as sold to customer">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Service Frequency:</label>
                                <select name="services[${serviceCounter}][serviceFrequency]" onchange="toggleCustomInput(this, 'serviceFreq_${serviceCounter}_custom')">
                                    <option value="Monthly">Monthly</option>
                                    <option value="Bi-Monthly">Bi-Monthly</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="One Time">One Time</option>
                                    <option value="21 Days">Every 21 Days</option>
                                    <option value="14 Days">Every 14 Days</option>
                                    <option value="10-14 Days">Every 10-14 Days</option>
                                    <option value="Custom">Custom Frequency</option>
                                </select>
                                <input type="text" id="serviceFreq_${serviceCounter}_custom" name="services[${serviceCounter}][serviceFrequencyCustom]" placeholder="Enter custom frequency..." style="display: none; margin-top: 8px;">
                            </div>
                            <div class="form-group">
                                <label>Billing Frequency:</label>
                                <select name="services[${serviceCounter}][billingFrequency]" onchange="toggleCustomInput(this, 'billingFreq_${serviceCounter}_custom')">
                                    <option value="Monthly">Monthly</option>
                                    <option value="After Service Completion">After Service Completion</option>
                                    <option value="Quarterly">Quarterly</option>
                                    <option value="Annually">Annually</option>
                                    <option value="Custom">Custom Billing</option>
                                </select>
                                <input type="text" id="billingFreq_${serviceCounter}_custom" name="services[${serviceCounter}][billingFrequencyCustom]" placeholder="Enter custom billing frequency..." style="display: none; margin-top: 8px;">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>First Service Price:</label>
                                <input type="text" name="services[${serviceCounter}][firstPrice]" placeholder="$150">
                            </div>
                            <div class="form-group">
                                <label>Recurring Price:</label>
                                <input type="text" name="services[${serviceCounter}][recurringPrice]" placeholder="$120">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Sqft Min:</label>
                                <input type="number" name="services[${serviceCounter}][sqftMin]" placeholder="0" min="0">
                            </div>
                            <div class="form-group">
                                <label>Sqft Max:</label>
                                <input type="number" name="services[${serviceCounter}][sqftMax]" placeholder="2500" min="0">
                            </div>
                        </div>
                        
                        <!-- Add Pricing Tier Button (moved below Sqft Min/Max as requested) -->
                        <div class="form-row">
                            <div class="form-group full-width">
                                <button type="button" class="btn btn-sm btn-primary add-btn" onclick="addPricingTier(${serviceCounter})" style="margin-top: 10px;">+ Add Pricing Tier</button>
                                <div class="help-text">Add additional pricing tiers for different square footage ranges</div>
                            </div>
                        </div>
                    </div>

                    <!-- Inspection Special Text -->
                    <div class="inspection-text" id="inspection-text-${serviceCounter}" style="display: none;">
                        <div class="form-group full-width">
                            <label>Agent Instructions:</label>
                            <textarea name="services[${serviceCounter}][agentInstructions]" rows="2" readonly style="background-color: #334155;"></textarea>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(serviceDiv);
            
            // Add initial service variant
            addServiceVariant(serviceCounter);
        }        // Add service variant function
        function addServiceVariant(serviceIndex) {
            const container = document.getElementById(`variants-container-${serviceIndex}`);
            const variantIndex = container.children.length + 1;
            
            const variantDiv = document.createElement('div');
            variantDiv.className = 'variant-item';
            
            variantDiv.innerHTML = `
                <div class="item-header" style="margin-bottom: 15px;">
                    <div class="item-title" style="color: #f1f5f9; font-weight: 600;">Variant ${variantIndex}</div>
                    <button type="button" class="btn btn-danger" onclick="removeServiceVariant(this)" style="padding: 4px 8px; font-size: 11px;">Remove</button>
                </div>
                
                <!-- Essential Fields (Same as Main Service) -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Variant Name:</label>
                        <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][name]" placeholder="e.g., Standard, Premium, with Mosquito">
                    </div>
                    <div class="form-group">
                        <label>Type:</label>
                        <select name="services[${serviceIndex}][variants][${variantIndex}][type]">
                            <option value="regular">Regular Service</option>
                            <option value="inspection">Inspection</option>
                            <option value="refer-office">Refer to Office</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Description:</label>
                        <textarea name="services[${serviceIndex}][variants][${variantIndex}][description]" rows="2" placeholder="Brief variant description..."></textarea>
                    </div>
                </div>

                <!-- Pests Covered (Above Pricing) -->
                <div class="form-row">
                    <div class="form-group full-width">
                        <label>Pests Covered:</label>
                        <textarea name="services[${serviceIndex}][variants][${variantIndex}][pests]" rows="2" placeholder="List pests covered by this variant..."></textarea>
                    </div>
                </div>

                <!-- Pricing Section -->
                <div class="service-pricing-section" style="background: #334155; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #475569;">
                    <h4 style="margin-bottom: 16px; color: #f1f5f9; font-size: 1.2em; font-weight: 600;">üí∞ Pricing Information</h4>
                    

                    <div class="form-row">
                        <div class="form-group">
                            <label>Product Type:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][productType]" placeholder="e.g., Pest Control, Termite">
                        </div>
                        <div class="form-group">
                            <label>Sold-As Name:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][soldAsName]" placeholder="Name as sold to customer">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Service Frequency:</label>
                            <select name="services[${serviceIndex}][variants][${variantIndex}][serviceFrequency]">
                                <option value="Monthly">Monthly</option>
                                <option value="Bi-Monthly">Bi-Monthly</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="One Time">One Time</option>
                                <option value="21 Days">Every 21 Days</option>
                                <option value="14 Days">Every 14 Days</option>
                                <option value="10-14 Days">Every 10-14 Days</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Billing Frequency:</label>
                            <select name="services[${serviceIndex}][variants][${variantIndex}][billingFrequency]">
                                <option value="Monthly">Monthly</option>
                                <option value="After Service Completion">After Service Completion</option>
                                <option value="Quarterly">Quarterly</option>
                                <option value="Annually">Annually</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>First Service Price:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][firstPrice]" placeholder="$150">
                        </div>
                        <div class="form-group">
                            <label>Recurring Price:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][recurringPrice]" placeholder="$120">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label>Sqft Min:</label>
                            <input type="number" name="services[${serviceIndex}][variants][${variantIndex}][sqftMin]" placeholder="0" min="0">
                        </div>
                        <div class="form-group">
                            <label>Sqft Max:</label>
                            <input type="number" name="services[${serviceIndex}][variants][${variantIndex}][sqftMax]" placeholder="2500" min="0">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label>Service Type:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][serviceTypeDesc]" placeholder="e.g., Monthly Subscription / Pest Control">
                        </div>
                    </div>
                </div>

                <!-- Service Details Section (Always Visible when 'Yes') -->
                <div class="form-row">
                    <div class="form-group">
                        <label>Service Details:</label>
                        <select name="services[${serviceIndex}][variants][${variantIndex}][hasDetails]" onchange="toggleVariantServiceDetails(this, ${serviceIndex}, ${variantIndex})">
                            <option value="Yes" selected>Yes</option>
                            <option value="None">None</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Note to Agent:</label>
                        <textarea name="services[${serviceIndex}][variants][${variantIndex}][agentNote]" rows="2" placeholder="Special instructions for agents..."></textarea>
                    </div>
                </div>

                <div class="service-details" id="variant-details-${serviceIndex}-${variantIndex}" style="display: block;">
                    <h4>Service Details</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label>How Often:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][frequency]" placeholder="Every 2-3 months">
                        </div>
                        <div class="form-group">
                            <label>Method:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][method]" placeholder="Spray/Granules">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Areas Treated:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][areas]" placeholder="Perimeter, basement, etc.">
                        </div>
                        <div class="form-group">
                            <label>Notes:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][notes]" placeholder="Additional service notes">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Contract:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][contract]" placeholder="e.g., None, 1 Year">
                        </div>
                        <div class="form-group">
                            <label>Guarantee:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][guarantee]" placeholder="e.g., None, Unlimited Reservices">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Call Ahead:</label>
                            <select name="services[${serviceIndex}][variants][${variantIndex}][callAhead]">
                                <option value="Yes">Yes</option>
                                <option value="No">No</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Initial Duration:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][initialDuration]" placeholder="e.g., 30 Minutes">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Recurring Duration:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][recurringDuration]" placeholder="e.g., 30 Minutes, N/A">
                        </div>
                        <div class="form-group">
                            <label>Leave During Service:</label>
                            <select name="services[${serviceIndex}][variants][${variantIndex}][leaveDuringService]">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Follow Up:</label>
                            <input type="text" name="services[${serviceIndex}][variants][${variantIndex}][followUp]" placeholder="e.g., No, 14 Days, Every 10-14 Days">
                        </div>
                        <div class="form-group">
                            <label>Prep Sheet:</label>
                            <select name="services[${serviceIndex}][variants][${variantIndex}][prepSheet]">
                                <option value="No">No</option>
                                <option value="Yes">Yes</option>
                                <option value="Refer to Home Office">Refer to Home Office</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(variantDiv);
        }

        // Remove service variant function
        function removeServiceVariant(button) {
            const variantDiv = button.closest('.variant-item');
            const container = variantDiv.parentElement;
            variantDiv.remove();
            
            // Renumber remaining variants
            const variants = container.querySelectorAll('.variant-item');
            variants.forEach((variant, index) => {
                const title = variant.querySelector('.item-title');
                title.textContent = `Variant ${index + 1}`;
            });
        }

        // Add technician function  
        function addTechnician() {
            technicianCounter++;
            const container = document.getElementById('technicians-container');
            
            const techDiv = document.createElement('div');
            techDiv.className = 'technician-item';
            techDiv.innerHTML = `
                <div class="item-header">
                    <div class="item-title">Technician #${technicianCounter}</div>
                    <button type="button" class="btn btn-danger remove-btn" onclick="removeTechnician(this)">Remove</button>
                </div>
                
                <!-- Order: Company Name, Tech or Inspector, Name, Schedule, Max Stops, Does NOT Service, Phone, Additional Notes, Zip Code or Branch -->
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Name (Required):</label>
                        <input type="text" name="technicians[${technicianCounter}][name]" placeholder="Technician name" required>
                    </div>
                    <div class="form-group">
                        <label>Tech or Inspector:</label>
                        <select name="technicians[${technicianCounter}][role]" onchange="toggleCustomInput(this, 'techRole_${technicianCounter}_custom')">
                            <option value="">Select Role</option>
                            <option value="Tech">Tech</option>
                            <option value="Inspector">Inspector</option>
                            <option value="Both">Both</option>
                            <option value="Custom">Custom Role</option>
                        </select>
                        <input type="text" id="techRole_${technicianCounter}_custom" name="technicians[${technicianCounter}][roleCustom]" placeholder="Enter custom role..." style="display: none; margin-top: 8px;">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Schedule:</label>
                        <input type="text" name="technicians[${technicianCounter}][schedule]" placeholder="Mon-Fri 8-5, Sat 8-12">
                    </div>
                    <div class="form-group">
                        <label>Max Stops:</label>
                        <input type="number" name="technicians[${technicianCounter}][maxStops]" min="1" max="50" placeholder="e.g., 12">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Does NOT Service:</label>
                        <textarea name="technicians[${technicianCounter}][doesNotService]" rows="2" placeholder="e.g., Termite, Commercial Only, Mosquito/Tick"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Phone:</label>
                        <input type="tel" name="technicians[${technicianCounter}][phone]" placeholder="Phone number">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Additional Notes:</label>
                        <textarea name="technicians[${technicianCounter}][additionalNotes]" rows="2" placeholder="Any additional information about this technician"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Zip Code or Branch (Optional):</label>
                        <input type="text" name="technicians[${technicianCounter}][zipCodeOrBranch]" placeholder="Specific zip codes or branch area">
                        <div class="help-text">Optional: Specific zip codes served or branch assignment</div>
                    </div>
                </div>
            `;
            
            container.appendChild(techDiv);
        }

        // Add service area function
        function addServiceArea() {
            areaCounter++;
            const container = document.getElementById('areas-container');
            
            const areaDiv = document.createElement('div');
            areaDiv.className = 'area-item';
            areaDiv.innerHTML = `
                <div class="item-header">
                    <div class="item-title">Service Area #${areaCounter}</div>
                    <button type="button" class="btn btn-danger remove-btn" onclick="removeServiceArea(this)">Remove</button>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>Zip Code:</label>
                        <input type="text" name="serviceAreas[${areaCounter}][zipCode]" placeholder="e.g., 75001" required>
                        <div class="help-text">Single zip code for this service area</div>
                    </div>
                    <div class="form-group">
                        <label>Branch (City):</label>
                        <input type="text" name="serviceAreas[${areaCounter}][branch]" placeholder="e.g., Dallas" required>
                        <div class="help-text">City or branch name for this area</div>
                    </div>
                </div>
            `;
            
            container.appendChild(areaDiv);
        }

        // Remove functions
        function removeService(button) {
            button.closest('.service-item').remove();
        }

        function removeTechnician(button) {
            button.closest('.technician-item').remove();
        }

        function removeServiceArea(button) {
            button.closest('.area-item').remove();
        }

        // Form submission
        document.getElementById('clientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            console.log('Form submission started...');
            
            // Remove HTML5 required validation from hidden fields
            const allRequiredFields = document.querySelectorAll('[required]');
            allRequiredFields.forEach(field => {
                const fieldContainer = field.closest('.service-content, .advanced-content, .service-details');
                if (fieldContainer && fieldContainer.style.display === 'none') {
                    field.removeAttribute('required');
                    field.setAttribute('data-was-required', 'true');
                }
            });
            
            // Basic validation check for visible required fields
            const companyName = document.getElementById('companyName').value.trim();
            const locations = document.getElementById('locations').value.trim();
            const phone = document.getElementById('officePhone').value.trim();
            const email = document.getElementById('customerContactEmail').value.trim();
            
            if (!companyName) {
                alert('Company Name is required');
                return;
            }
            if (!locations) {
                alert('Location is required');
                return;
            }
            if (!phone) {
                alert('Phone number is required');
                return;
            }
            if (!email) {
                alert('Email is required');
                return;
            }
            
            console.log('Basic validation passed');
            
            // Show loading state
            const submitButton = document.getElementById('submitButton');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Creating Profile...';
            submitButton.disabled = true;
            
            // Collect form data
            const formData = new FormData(this);
            const clientData = {};
            
            // Convert FormData to object
            for (let [key, value] of formData.entries()) {
                if (key.includes('[') && key.includes(']')) {
                    // Handle array data (services, technicians, etc.)
                    const matches = key.match(/(\w+)\[(\d+)\]\[(\w+)\]/);
                    if (matches) {
                        const [, arrayName, index, fieldName] = matches;
                        if (!clientData[arrayName]) clientData[arrayName] = [];
                        if (!clientData[arrayName][index]) clientData[arrayName][index] = {};
                        clientData[arrayName][index][fieldName] = value;
                    }
                } else if (key === 'holidays') {
                    // Handle checkbox arrays (holidays)
                    if (!clientData[key]) clientData[key] = [];
                    clientData[key].push(value);
                } else {
                    clientData[key] = value;
                }
            }
            
            // Check if we're in edit mode or creating new (use template variables like in checkEditMode)
            const templateProfileId = '<?= profileId ?>';
            const templateEditMode = '<?= editMode ?>';
            
            // Also try URL parsing as fallback
            const urlParams = new URLSearchParams(window.location.search);
            const urlProfileId = urlParams.get('profileId');
            const urlEditMode = urlParams.get('edit');
            
            // Use template variables first, fallback to URL
            const finalProfileId = templateProfileId || urlProfileId;
            const finalEditMode = templateEditMode || urlEditMode;
            const isEditMode = finalEditMode === 'true';
            
            console.log('Submission Parameters:', {
                templateProfileId: templateProfileId,
                templateEditMode: templateEditMode,
                urlProfileId: urlProfileId,
                urlEditMode: urlEditMode,
                finalProfileId: finalProfileId,
                finalEditMode: finalEditMode,
                isEditMode: isEditMode,
                fullURL: window.location.href
            });
            
            // Get the Profile_ID (from template/URL if editing, or session if creating)
            let profileId = isEditMode && finalProfileId ? finalProfileId : sessionStorage.getItem('currentProfileId');
            
            if (!profileId) {
                // Fallback: generate new Profile_ID
                profileId = 'profile_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                sessionStorage.setItem('currentProfileId', profileId);
            }
            
            clientData.profileId = profileId;
            console.log(`${isEditMode ? 'Updating' : 'Creating'} profile with ID:`, profileId);
            console.log('Will call function:', isEditMode ? 'updateClientProfileFromHTML' : 'createClientProfileFromHTML');
            
            // Submit to Google Apps Script with proper conditional logic
            if (isEditMode) {
                // Update existing profile
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Update success:', result);
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        onSuccess(result);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Update error:', error);
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        onError(error);
                    })
                    .updateClientProfileFromHTML(clientData);
            } else {
                // Create new profile
                google.script.run
                    .withSuccessHandler(function(result) {
                        console.log('Create success:', result);
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        
                        // Clear session after successful creation
                        sessionStorage.removeItem('currentProfileId');
                        
                        onSuccess(result);
                    })
                    .withFailureHandler(function(error) {
                        console.error('Create error:', error);
                        submitButton.textContent = originalText;
                        submitButton.disabled = false;
                        onError(error);
                    })
                    .createClientProfileFromHTML(clientData);
            }
                
            console.log('Google Script call initiated...');
        });

        function onSuccess(result) {
            let message = 'Client profile created successfully!\n\n';
            
            if (result.profileId) {
                message += `üÜî Profile ID: ${result.profileId}\n`;
            }
            
            if (result.profileUrl) {
                message += `üåê Profile URL: ${result.profileUrl}\n`;
            }
            
            message += '\nüìä Profile added to Master Client Profiles sheet\n';
            message += '\n' + (result.message || 'Profile ready for use!');
            
            alert(message);
            
            // Update sidebar links
            if (result.profileUrl) {
                const profileLink = document.getElementById('sidebarProfileLink');
                if (profileLink) {
                profileLink.href = result.profileUrl;
                profileLink.classList.remove('disabled');
                }
            }
            
            // Drive folder link should already be updated from the input
            const googleDriveFolder = document.getElementById('sidebarGoogleDriveFolder').value;
            if (googleDriveFolder) {
                const driveLink = document.getElementById('sidebarDriveLink');
                driveLink.href = googleDriveFolder;
                driveLink.classList.remove('disabled');
            }
            
            // Scroll to top to highlight the sidebar
            window.scrollTo(0, 0);
        }

        function onError(error) {
            alert('Error creating profile: ' + error.message);
        }

        // Note: Service, technician, and area initialization moved to main DOMContentLoaded handler

        // Add pricing tier function
        function addPricingTier(serviceIndex) {
            const container = document.getElementById(`pricingTiers_${serviceIndex}`).querySelector('.pricing-tiers-list');
            const tierIndex = container.children.length + 1;
            
            const tierDiv = document.createElement('div');
            tierDiv.className = 'form-row';
            tierDiv.innerHTML = `
                <div class="form-group">
                    <label>Tier ${tierIndex} Min Sqft:</label>
                    <input type="number" name="services[${serviceIndex}][tiers][${tierIndex}][minSqft]" placeholder="e.g., 0" min="0" required>
                </div>
                <div class="form-group">
                    <label>Tier ${tierIndex} Max Sqft:</label>
                    <input type="number" name="services[${serviceIndex}][tiers][${tierIndex}][maxSqft]" placeholder="e.g., 2500" min="0" required>
                </div>
                <div class="form-group">
                    <label>Tier ${tierIndex} First Price:</label>
                    <input type="text" name="services[${serviceIndex}][tiers][${tierIndex}][firstPrice]" placeholder="$150" required>
                </div>
                <div class="form-group">
                    <label>Tier ${tierIndex} Recurring Price:</label>
                    <input type="text" name="services[${serviceIndex}][tiers][${tierIndex}][recurringPrice]" placeholder="$120" required>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-danger" onclick="removePricingTier(this)">Remove Tier</button>
                </div>
            `;
            
            container.appendChild(tierDiv);
        }

        // Remove pricing tier function
        function removePricingTier(button) {
            const tierDiv = button.closest('.form-row');
            tierDiv.remove();
            
            // Renumber remaining tiers
            const serviceIndex = tierDiv.closest('.service-item').querySelector('.service-title').textContent.split('#')[1].split(' -')[0];
            const tiers = tierDiv.parentElement.querySelectorAll('.form-row');
            tiers.forEach((tier, index) => {
                const minSqftLabel = tier.querySelector('label');
                minSqftLabel.textContent = `Tier ${index + 1} Min Sqft:`;
                
                const maxSqftLabel = tier.querySelector('label');
                maxSqftLabel.textContent = `Tier ${index + 1} Max Sqft:`;
                
                const firstPriceLabel = tier.querySelector('label');
                firstPriceLabel.textContent = `Tier ${index + 1} First Price:`;
                
                const recurringPriceLabel = tier.querySelector('label');
                recurringPriceLabel.textContent = `Tier ${index + 1} Recurring Price:`;
            });
        }

        // Address copy function
        function copyPhysicalAddress() {
            const sameAsPhysical = document.getElementById('sameAsPhysical').checked;
            if (sameAsPhysical) {
                document.getElementById('mailingStreet').value = document.getElementById('physicalStreet').value;
                document.getElementById('mailingSuite').value = document.getElementById('physicalSuite').value;
                document.getElementById('mailingCity').value = document.getElementById('physicalCity').value;
                
                // Copy state value and display
                const physicalState = document.getElementById('physicalState');
                const mailingState = document.getElementById('mailingState');
                mailingState.value = physicalState.value;
                mailingState.placeholder = physicalState.placeholder;
                mailingState.setAttribute('data-display', physicalState.getAttribute('data-display') || '');
                
                document.getElementById('mailingZip').value = document.getElementById('physicalZip').value;
            } else {
                document.getElementById('mailingStreet').value = '';
                document.getElementById('mailingSuite').value = '';
                document.getElementById('mailingCity').value = '';
                
                // Reset state field
                const mailingState = document.getElementById('mailingState');
                mailingState.value = '';
                mailingState.placeholder = 'Type to search states...';
                mailingState.removeAttribute('data-display');
                
                document.getElementById('mailingZip').value = '';
            }
        }

        // Office Hours Functions - Initialize on page load
        function initializeOfficeHours() {
            const hoursGrid = document.getElementById('hoursGrid');
            if (!hoursGrid) return;
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const dayAbbrev = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            
            const timeOptions = [
                { value: '06:00', label: '6:00 AM' }, { value: '07:00', label: '7:00 AM' },
                { value: '08:00', label: '8:00 AM' }, { value: '09:00', label: '9:00 AM' },
                { value: '10:00', label: '10:00 AM' }, { value: '11:00', label: '11:00 AM' },
                { value: '12:00', label: '12:00 PM' }, { value: '13:00', label: '1:00 PM' },
                { value: '14:00', label: '2:00 PM' }, { value: '15:00', label: '3:00 PM' },
                { value: '16:00', label: '4:00 PM' }, { value: '17:00', label: '5:00 PM' },
                { value: '18:00', label: '6:00 PM' }, { value: '19:00', label: '7:00 PM' },
                { value: '20:00', label: '8:00 PM' }
            ];

            days.forEach((day, index) => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day-hours';
                dayDiv.innerHTML = `
                    <label class="day-label">${day}</label>
                    <input type="checkbox" id="${dayAbbrev[index]}-open" onchange="toggleDayHours('${dayAbbrev[index]}')">
                    <select id="${dayAbbrev[index]}-start" class="time-select" disabled>
                        <option value="">Start</option>
                        ${timeOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                    </select>
                    <span class="to-label">to</span>
                    <select id="${dayAbbrev[index]}-end" class="time-select" disabled>
                        <option value="">End</option>
                        ${timeOptions.map(opt => `<option value="${opt.value}">${opt.label}</option>`).join('')}
                    </select>
                `;
                hoursGrid.appendChild(dayDiv);
                
                // Add change listeners
                document.getElementById(dayAbbrev[index] + '-start').addEventListener('change', updateOfficeHoursField);
                document.getElementById(dayAbbrev[index] + '-end').addEventListener('change', updateOfficeHoursField);
            });
        }

        function toggleDayHours(day) {
            const checkbox = document.getElementById(day + '-open');
            const startSelect = document.getElementById(day + '-start');
            const endSelect = document.getElementById(day + '-end');
            
            if (checkbox.checked) {
                startSelect.disabled = false;
                endSelect.disabled = false;
            } else {
                startSelect.disabled = true;
                endSelect.disabled = true;
                startSelect.value = '';
                endSelect.value = '';
            }
            updateOfficeHoursField();
        }

        function updateOfficeHoursField() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri', 'sat', 'sun'];
            const dayNames = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            let hoursText = '';
            
            days.forEach((day, index) => {
                const checkbox = document.getElementById(day + '-open');
                if (checkbox && checkbox.checked) {
                    const start = document.getElementById(day + '-start').value;
                    const end = document.getElementById(day + '-end').value;
                    if (start && end) {
                        const startTime = formatTime(start);
                        const endTime = formatTime(end);
                        hoursText += `${dayNames[index]}: ${startTime} - ${endTime}\n`;
                    }
                }
            });
            
            document.getElementById('officeHours').value = hoursText.trim();
        }

        function formatTime(time24) {
            const [hours, minutes] = time24.split(':');
            const hour12 = hours % 12 || 12;
            const ampm = hours < 12 ? 'AM' : 'PM';
            return `${hour12}:${minutes} ${ampm}`;
        }

        // URL formatting function
        function formatURL(input) {
            let value = input.value.trim();
            if (value && !value.startsWith('http://') && !value.startsWith('https://')) {
                input.value = 'https://' + value;
            }
        }

        // Pre-select default office hours (Monday-Friday 8am-5pm)
        function setDefaultOfficeHours() {
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            
            days.forEach(day => {
                const checkbox = document.getElementById(day + '-open');
                const startSelect = document.getElementById(day + '-start');
                const endSelect = document.getElementById(day + '-end');
                
                if (checkbox && startSelect && endSelect) {
                    checkbox.checked = true;
                    startSelect.disabled = false;
                    endSelect.disabled = false;
                    startSelect.value = '08:00';
                    endSelect.value = '17:00';
                }
            });
            
            updateOfficeHoursField();
        }

        // ZIP Code Management Functions
        let zipCodeData = [];

        function handleFileUpload(fileInput) {
            const file = fileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const csv = e.target.result;
                parseCSVContent(csv);
            };
            reader.readAsText(file);
        }

        function parseZipCodeInput(textarea) {
            const content = textarea.value.trim();
            if (!content) {
                hideZipPreview();
                return;
            }
            parseCSVContent(content);
        }

        function parseCSVContent(csvContent) {
            const lines = csvContent.split('\n').filter(line => line.trim());
            const zipData = [];
            
            lines.forEach(line => {
                const parts = line.split(',').map(p => p.trim().replace(/['"]/g, ''));
                
                if (parts.length >= 2) {
                    // Format: ZIP, City
                    const zip = parts[0].replace(/\D/g, ''); // Remove non-digits
                    const city = parts[1];
                    if (zip.length === 5) {
                        zipData.push({ zip: zip, city: city });
                    }
                } else if (parts.length === 1) {
                    // Just ZIP code
                    const zip = parts[0].replace(/\D/g, '');
                    if (zip.length === 5) {
                        const autoResolve = document.getElementById('autoResolveCity').checked;
                        zipData.push({ 
                            zip: zip, 
                            city: autoResolve ? `City for ${zip}` : 'Unknown City'
                        });
                    }
                }
            });

            if (zipData.length > 0) {
                zipCodeData = zipData;
                showZipPreview();
            } else {
                hideZipPreview();
            }
        }

        function showZipPreview() {
            const previewSection = document.getElementById('zipPreviewSection');
            const zipCountElement = document.getElementById('zipCount');
            const zipListElement = document.getElementById('zipPreviewList');

            zipCountElement.textContent = zipCodeData.length;
            
            let listHTML = '';
            zipCodeData.forEach(item => {
                listHTML += `
                    <div class="zip-item">
                        <span class="zip-code">${item.zip}</span>
                        <span class="zip-city">${item.city}</span>
                    </div>
                `;
            });
            
            zipListElement.innerHTML = listHTML;
            previewSection.style.display = 'block';
        }

        function hideZipPreview() {
            document.getElementById('zipPreviewSection').style.display = 'none';
            zipCodeData = [];
        }

        function approveZipCodes() {
            // Store the ZIP code data in the hidden field
            document.getElementById('serviceAreasData').value = JSON.stringify(zipCodeData);
            
            // Show confirmation
            alert(`‚úÖ ${zipCodeData.length} service areas approved and ready for submission!`);
            
            // Optionally collapse the preview for cleaner view
            document.getElementById('zipPreviewSection').style.display = 'none';
        }

        function editZipCodes() {
            // Convert back to editable text format
            let editableText = zipCodeData.map(item => `${item.zip}, ${item.city}`).join('\n');
            document.getElementById('zipCodePaste').value = editableText;
            document.getElementById('zipCodePaste').focus();
        }

        function clearZipCodes() {
            zipCodeData = [];
            document.getElementById('zipCodePaste').value = '';
            document.getElementById('zipCodeFile').value = '';
            document.getElementById('serviceAreasData').value = '';
            hideZipPreview();
        }

        // Check if we're in edit mode and load existing data
        function checkEditMode() {
            console.log('=== CHECKING EDIT MODE ===');
            
            // Get parameters from server-side template variables (passed from doGet)
            const profileId = '<?= profileId ?>';
            const editMode = '<?= editMode ?>';
            
            // Also try URL parsing as fallback
            const urlParams = new URLSearchParams(window.location.search);
            const urlProfileId = urlParams.get('profileId');
            const urlEditMode = urlParams.get('edit');
            
            // Use template variables first, fallback to URL
            const finalProfileId = profileId || urlProfileId;
            const finalEditMode = editMode || urlEditMode;
            
            console.log('Parameters found:');
            console.log('- Template profileId:', profileId);
            console.log('- Template editMode:', editMode);
            console.log('- URL profileId:', urlProfileId);
            console.log('- URL editMode:', urlEditMode);
            console.log('- Final profileId:', finalProfileId);
            console.log('- Final editMode:', finalEditMode);
            console.log('- finalEditMode === "true":', finalEditMode === 'true');
            
            if (finalProfileId && finalEditMode === 'true') {
                console.log('=== EDIT MODE CONFIRMED ===');
                // We're in edit mode
                document.getElementById('submitButton').textContent = 'Update Client Profile';
                document.title = 'Edit Client Profile - ' + document.title;
                
                console.log('Setting up data loading with 500ms delay...');
                // Load existing data for this profileId (with delay to ensure form is ready)
                setTimeout(() => {
                    console.log('Delay complete, calling loadExistingProfileData...');
                    loadExistingProfileData(finalProfileId);
                }, 500);
                return true;
            } else {
                console.log('=== NOT IN EDIT MODE ===');
                console.log('Reason: finalProfileId =', finalProfileId, ', finalEditMode =', finalEditMode);
            }
            return false;
        }
        
        function loadExistingProfileData(profileId) {
            console.log('=== LOADING EXISTING PROFILE DATA ===');
            console.log('Profile ID:', profileId);
            console.log('Current URL:', window.location.href);
            
            // Set the Profile_ID in session storage to prevent creating new one
            sessionStorage.setItem('currentProfileId', profileId);
            
            // Show loading state
            showProgressStatus('üìÇ Loading profile data...', 'warning');
            
            // Load data from Google Apps Script
            google.script.run
                .withSuccessHandler(function(profileData) {
                    console.log('=== PROFILE DATA RECEIVED ===');
                    console.log('Full profile data:', profileData);
                    
                    if (profileData && !profileData.error) {
                        console.log('Profile data is valid, populating form...');
                        populateFormWithData(profileData);
                        showProgressStatus('‚úÖ Profile data loaded successfully', 'success');
                    } else {
                        console.error('=== PROFILE LOAD ERROR ===');
                        console.error('Error details:', profileData);
                        showProgressStatus('‚ùå Profile not found', 'error');
                    }
                })
                .withFailureHandler(function(error) {
                    console.error('=== GOOGLE SCRIPT FAILURE ===');
                    console.error('Error details:', error);
                    showProgressStatus('‚ùå Error loading profile data', 'error');
                })
                .getProfileDataById(profileId);
                
            console.log('Google Script call for profile data initiated...');
        }

        // Helper function to set field values with better error handling
        const setFieldValue = (id, value) => {
            const element = document.getElementById(id) || document.querySelector(`[name="${id}"]`);
            if (element && value !== null && value !== undefined && value !== '') {
                element.value = value;
                console.log(`Set ${id} = ${value}`);
                return true;
            } else if (!element) {
                console.warn(`Element not found: ${id}`);
            }
            return false;
        };

        function populateFormWithData(profileData) {
            console.log('Populating form with:', profileData);
            
            try {
                
                // Main profile fields
                setFieldValue('companyName', profileData.companyName);
                setFieldValue('locations', profileData.location);
                setFieldValue('timezone', profileData.timezone);
                
                // Office info
                if (profileData.officeInfo) {
                    setFieldValue('officePhone', profileData.officeInfo.phone);
                    setFieldValue('customerContactEmail', profileData.officeInfo.email);
                    setFieldValue('website', profileData.officeInfo.website);
                    setFieldValue('officeHours', profileData.officeInfo.hours);
                    
                    // Parse address if available
                    if (profileData.officeInfo.address) {
                        console.log('Parsing address:', profileData.officeInfo.address);
                        // Try to parse the combined address back into separate fields
                        const addressParts = profileData.officeInfo.address.split(', ');
                        if (addressParts.length >= 3) {
                            setFieldValue('physicalStreet', addressParts[0]);
                            setFieldValue('physicalSuite', addressParts[1]);
                            setFieldValue('physicalCity', addressParts[2]);
                            
                            // Try to extract state and ZIP from last part
                            if (addressParts.length >= 4) {
                                const lastPart = addressParts[addressParts.length - 1];
                                const stateZipMatch = lastPart.match(/([A-Z]{2})\s+(\d{5})/);
                                if (stateZipMatch) {
                                    setFieldValue('physicalState', stateZipMatch[1]);
                                    setFieldValue('physicalZip', stateZipMatch[2]);
                                }
                            }
                        }
                    }
                }
                
                // Other fields
                setFieldValue('bulletin', profileData.bulletin);
                setFieldValue('pestsNotCovered', profileData.pestsNotCovered);
                
                // Client folder URL
                if (profileData.clientFolderUrl) {
                    setFieldValue('sidebarGoogleDriveFolder', profileData.clientFolderUrl);
                    updateDriveLink();
                }
                
                // Debug what data is available
                console.log('=== AVAILABLE DATA SECTIONS ===');
                console.log('Services:', profileData.services ? `${profileData.services.length} items` : 'NONE');
                console.log('Technicians:', profileData.technicians ? `${profileData.technicians.length} items` : 'NONE');
                console.log('Service Areas:', profileData.serviceAreas ? `${profileData.serviceAreas.length} items` : 'NONE');
                console.log('Policies:', profileData.policies ? `${Object.keys(profileData.policies).length} categories` : 'NONE');
                
                // Populate services data if available
                if (profileData.services && profileData.services.length > 0) {
                    console.log('Populating services:', profileData.services);
                    setTimeout(() => {
                        populateServicesData(profileData.services);
                    }, 1000);
                } else {
                    console.log('No services data to populate');
                }
                
                // Populate technicians data if available
                if (profileData.technicians && profileData.technicians.length > 0) {
                    console.log('Populating technicians:', profileData.technicians);
                    setTimeout(() => {
                        populateTechniciansData(profileData.technicians);
                    }, 1200);
                } else {
                    console.log('No technicians data to populate');
                }
                
                // Populate service areas data if available
                if (profileData.serviceAreas && profileData.serviceAreas.length > 0) {
                    console.log('Populating service areas:', profileData.serviceAreas);
                    setTimeout(() => {
                        populateServiceAreasData(profileData.serviceAreas);
                    }, 1400);
                } else {
                    console.log('No service areas data to populate. Available:', profileData.serviceAreas);
                }
                
                // Populate policies data if available
                if (profileData.policies && Object.keys(profileData.policies).length > 0) {
                    console.log('Populating policies:', profileData.policies);
                    setTimeout(() => {
                        populatePoliciesData(profileData.policies);
                    }, 1600);
                } else {
                    console.log('No policies data to populate. Available:', profileData.policies);
                }
                
                console.log('Form population completed successfully');
                
            } catch (error) {
                console.error('Error populating form:', error);
                showProgressStatus('‚ùå Error loading form data', 'error');
            }
        }

        // Populate Services section with existing data
        function populateServicesData(services) {
            console.log('Populating services section with:', services);
            
            // Clear existing services first (except the default one)
            const servicesContainer = document.getElementById('services-container');
            if (servicesContainer) {
                servicesContainer.innerHTML = '';
            }
            
            // Reset service counter
            serviceCounter = 0;
            
            // Add each service
            services.forEach((service, index) => {
                addService(); // This creates a new service form
                
                // Populate the service fields
                setTimeout(() => {
                    const serviceIndex = serviceCounter;
                    console.log(`Populating service ${serviceIndex}:`, service);
                    
                    // Basic service information
                    setFieldValue(`services[${serviceIndex}][name]`, service.name);
                    setFieldValue(`services[${serviceIndex}][description]`, service.description);
                    setFieldValue(`services[${serviceIndex}][type]`, service.type);
                    setFieldValue(`services[${serviceIndex}][frequency]`, service.frequency);
                    setFieldValue(`services[${serviceIndex}][pests]`, service.pests);
                    
                    // Service details
                    setFieldValue(`services[${serviceIndex}][contract]`, service.contract);
                    setFieldValue(`services[${serviceIndex}][guarantee]`, service.guarantee);
                    setFieldValue(`services[${serviceIndex}][initialDuration]`, service.duration);
                    setFieldValue(`services[${serviceIndex}][productType]`, service.productType);
                    setFieldValue(`services[${serviceIndex}][billingFrequency]`, service.billingFrequency);
                    setFieldValue(`services[${serviceIndex}][noteToAgent]`, service.agentNote);
                    
                    // Parse pricing data if available
                    console.log(`Service ${serviceIndex} pricing data:`, service.pricingData);
                    if (service.pricingData) {
                        try {
                            const pricingArray = JSON.parse(service.pricingData);
                            console.log(`Parsed pricing array for service ${serviceIndex}:`, pricingArray);
                            if (pricingArray && pricingArray.length > 0) {
                                const pricing = pricingArray[0];
                                console.log(`Using pricing object:`, pricing);
                                setFieldValue(`services[${serviceIndex}][firstPrice]`, pricing.firstPrice);
                                setFieldValue(`services[${serviceIndex}][recurringPrice]`, pricing.recurringPrice);
                                setFieldValue(`services[${serviceIndex}][sqftMin]`, pricing.sqftMin);
                                setFieldValue(`services[${serviceIndex}][sqftMax]`, pricing.sqftMax);
                                setFieldValue(`services[${serviceIndex}][serviceTypeDesc]`, pricing.serviceType);
                                setFieldValue(`services[${serviceIndex}][serviceFrequency]`, pricing.serviceFrequency || service.billingFrequency);
                            }
                        } catch (e) {
                            console.error('Error parsing pricing data for service', serviceIndex, ':', e);
                            console.error('Raw pricing data was:', service.pricingData);
                        }
                    } else {
                        console.log(`No pricing data available for service ${serviceIndex}`);
                    }
                    
                    console.log(`Service ${serviceIndex} population completed`);
                }, index * 200); // Stagger the population
            });
        }

        // Populate Technicians section with existing data
        function populateTechniciansData(technicians) {
            console.log('Populating technicians section with:', technicians);
            
            // Clear existing technicians first
            const techniciansContainer = document.getElementById('technicians-container');
            if (techniciansContainer) {
                techniciansContainer.innerHTML = '';
            }
            
            // Reset technician counter
            technicianCounter = 0;
            
            // Add each technician
            technicians.forEach((tech, index) => {
                addTechnician(); // This creates a new technician form
                
                setTimeout(() => {
                    const techIndex = technicianCounter;
                    console.log(`Populating technician ${techIndex}:`, tech);
                    
                    // Map all technician fields from sheet to form
                    setFieldValue(`technicians[${techIndex}][name]`, tech.name || tech.techName);
                    setFieldValue(`technicians[${techIndex}][role]`, tech.role);
                    setFieldValue(`technicians[${techIndex}][phone]`, tech.phone);
                    setFieldValue(`technicians[${techIndex}][schedule]`, tech.schedule);
                    setFieldValue(`technicians[${techIndex}][maxStops]`, tech.maxStops);
                    setFieldValue(`technicians[${techIndex}][doesNotService]`, tech.doesNotService);
                    setFieldValue(`technicians[${techIndex}][additionalNotes]`, tech.additionalNotes);
                    setFieldValue(`technicians[${techIndex}][zipCodeOrBranch]`, tech.zipCodes);
                    
                    console.log(`Technician ${techIndex} population completed`);
                }, index * 200);
            });
        }

        // Populate Service Areas section with existing data
        function populateServiceAreasData(serviceAreas) {
            console.log('Populating service areas section with:', serviceAreas);
            
            // Convert service areas back to CSV format for the bulk input
            const csvData = serviceAreas.map(area => `${area.zip}, ${area.city}`).join('\n');
            
            setTimeout(() => {
                const zipCodePaste = document.getElementById('zipCodePaste');
                if (zipCodePaste) {
                    zipCodePaste.value = csvData;
                    // Trigger the parsing
                    parseZipCodeInput(zipCodePaste);
                    // Auto-approve the ZIP codes
                    setTimeout(() => {
                        if (zipCodeData.length > 0) {
                            approveZipCodes();
                        }
                    }, 500);
                }
            }, 100);
        }

        // Populate Policies section with existing data
        function populatePoliciesData(policies) {
            console.log('Populating policies section with:', policies);
            
            // Handle both array and grouped object formats
            if (Array.isArray(policies)) {
                // Flat array format
                policies.forEach(policy => {
                    mapPolicyToFormField(policy.category, policy.description, policy.options);
                });
            } else if (typeof policies === 'object') {
                // Grouped object format
                Object.keys(policies).forEach(category => {
                    const categoryPolicies = policies[category];
                    if (Array.isArray(categoryPolicies)) {
                        categoryPolicies.forEach(policy => {
                            mapPolicyToFormField(category, policy.description, policy.options);
                        });
                    }
                });
            }
        }

        function mapPolicyToFormField(category, description, options) {
            // Map policy categories to form fields
            switch(category) {
                case 'Cancellation':
                    setFieldValue('cancellationPolicy', description);
                    break;
                case 'Payment':
                    setFieldValue('paymentPlans', description);
                    if (options) setFieldValue('paymentTypes', options);
                    break;
                case 'Emergency':
                    setFieldValue('afterHoursEmergency', description);
                    break;
                case 'Contract':
                    setFieldValue('signedContract', description);
                    break;
                default:
                    console.log(`Unmapped policy category: ${category}`);
            }
        }

        // US States data for searchable dropdown
        const US_STATES = [
            { code: 'AL', name: 'Alabama' },
            { code: 'AK', name: 'Alaska' },
            { code: 'AZ', name: 'Arizona' },
            { code: 'AR', name: 'Arkansas' },
            { code: 'CA', name: 'California' },
            { code: 'CO', name: 'Colorado' },
            { code: 'CT', name: 'Connecticut' },
            { code: 'DE', name: 'Delaware' },
            { code: 'FL', name: 'Florida' },
            { code: 'GA', name: 'Georgia' },
            { code: 'HI', name: 'Hawaii' },
            { code: 'ID', name: 'Idaho' },
            { code: 'IL', name: 'Illinois' },
            { code: 'IN', name: 'Indiana' },
            { code: 'IA', name: 'Iowa' },
            { code: 'KS', name: 'Kansas' },
            { code: 'KY', name: 'Kentucky' },
            { code: 'LA', name: 'Louisiana' },
            { code: 'ME', name: 'Maine' },
            { code: 'MD', name: 'Maryland' },
            { code: 'MA', name: 'Massachusetts' },
            { code: 'MI', name: 'Michigan' },
            { code: 'MN', name: 'Minnesota' },
            { code: 'MS', name: 'Mississippi' },
            { code: 'MO', name: 'Missouri' },
            { code: 'MT', name: 'Montana' },
            { code: 'NE', name: 'Nebraska' },
            { code: 'NV', name: 'Nevada' },
            { code: 'NH', name: 'New Hampshire' },
            { code: 'NJ', name: 'New Jersey' },
            { code: 'NM', name: 'New Mexico' },
            { code: 'NY', name: 'New York' },
            { code: 'NC', name: 'North Carolina' },
            { code: 'ND', name: 'North Dakota' },
            { code: 'OH', name: 'Ohio' },
            { code: 'OK', name: 'Oklahoma' },
            { code: 'OR', name: 'Oregon' },
            { code: 'PA', name: 'Pennsylvania' },
            { code: 'RI', name: 'Rhode Island' },
            { code: 'SC', name: 'South Carolina' },
            { code: 'SD', name: 'South Dakota' },
            { code: 'TN', name: 'Tennessee' },
            { code: 'TX', name: 'Texas' },
            { code: 'UT', name: 'Utah' },
            { code: 'VT', name: 'Vermont' },
            { code: 'VA', name: 'Virginia' },
            { code: 'WA', name: 'Washington' },
            { code: 'WV', name: 'West Virginia' },
            { code: 'WI', name: 'Wisconsin' },
            { code: 'WY', name: 'Wyoming' }
        ];

        // Initialize state dropdowns
        function initializeStateDropdowns() {
            ['physicalState', 'mailingState'].forEach(fieldId => {
                populateStateDropdown(fieldId);
            });
        }

        function populateStateDropdown(fieldId) {
            const dropdown = document.getElementById(fieldId + 'Dropdown');
            if (!dropdown) return;

            let html = '';
            US_STATES.forEach(state => {
                html += `<div class="searchable-select-option" onclick="selectState('${fieldId}', '${state.code}', '${state.name}')">${state.name} (${state.code})</div>`;
            });
            dropdown.innerHTML = html;
        }

        function showStateDropdown(fieldId) {
            const dropdown = document.getElementById(fieldId + 'Dropdown');
            if (dropdown) {
                dropdown.style.display = 'block';
                populateStateDropdown(fieldId); // Reset to show all states
            }
        }

        function hideStateDropdown(fieldId) {
            const dropdown = document.getElementById(fieldId + 'Dropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        function toggleStateDropdown(fieldId) {
            const dropdown = document.getElementById(fieldId + 'Dropdown');
            if (dropdown) {
                if (dropdown.style.display === 'none') {
                    showStateDropdown(fieldId);
                } else {
                    hideStateDropdown(fieldId);
                }
            }
        }

        function filterStates(fieldId) {
            const input = document.getElementById(fieldId);
            const dropdown = document.getElementById(fieldId + 'Dropdown');
            const searchTerm = input.value.toLowerCase();

            if (!dropdown) return;

            let filteredStates = US_STATES.filter(state => 
                state.name.toLowerCase().includes(searchTerm) || 
                state.code.toLowerCase().includes(searchTerm)
            );

            let html = '';
            if (filteredStates.length > 0) {
                filteredStates.forEach(state => {
                    html += `<div class="searchable-select-option" onclick="selectState('${fieldId}', '${state.code}', '${state.name}')">${state.name} (${state.code})</div>`;
                });
            } else {
                html = '<div class="no-results">No states found</div>';
            }

            dropdown.innerHTML = html;
            dropdown.style.display = 'block';
        }

        function selectState(fieldId, stateCode, stateName) {
            const input = document.getElementById(fieldId);
            if (input) {
                input.value = stateCode; // Store the state code as the value
                input.setAttribute('data-display', stateName); // Store display name
                input.placeholder = `${stateName} (${stateCode})`; // Show selected state in placeholder
            }
            hideStateDropdown(fieldId);
        }

        // Hide dropdown when clicking outside
        document.addEventListener('click', function(e) {
            ['physicalState', 'mailingState'].forEach(fieldId => {
                const container = e.target.closest('.searchable-select-container');
                const targetContainer = document.getElementById(fieldId).closest('.searchable-select-container');
                
                if (container !== targetContainer) {
                    hideStateDropdown(fieldId);
                }
            });
        });

        // Manual Progress Save/Load Functions
        function saveFormProgress() {
            try {
                const formData = new FormData(document.getElementById('clientForm'));
                const progressData = {};
                
                // Convert FormData to object for storage
                for (let [key, value] of formData.entries()) {
                    if (key === 'holidays') {
                        if (!progressData[key]) progressData[key] = [];
                        progressData[key].push(value);
                    } else {
                        progressData[key] = value;
                    }
                }
                
                // Save to localStorage with timestamp
                const saveData = {
                    data: progressData,
                    timestamp: new Date().toISOString(),
                    companyName: progressData.companyName || 'Unnamed Client'
                };
                
                localStorage.setItem('clientFormProgress', JSON.stringify(saveData));
                
                showProgressStatus('‚úÖ Progress saved locally', 'success');
                console.log('Form progress saved:', saveData);
                
            } catch (error) {
                showProgressStatus('‚ùå Error saving progress', 'error');
                console.error('Save progress error:', error);
            }
        }

        function loadFormProgress() {
            try {
                const savedData = localStorage.getItem('clientFormProgress');
                if (!savedData) {
                    showProgressStatus('‚ö†Ô∏è No saved progress found', 'warning');
                    return;
                }
                
                const parseData = JSON.parse(savedData);
                const savedDate = new Date(parseData.timestamp);
                const companyName = parseData.companyName;
                
                // Confirm before loading
                const confirmLoad = confirm(
                    `Load saved progress?\\n\\n` +
                    `Company: ${companyName}\\n` +
                    `Saved: ${savedDate.toLocaleDateString()} at ${savedDate.toLocaleTimeString()}\\n\\n` +
                    `This will overwrite current form data.`
                );
                
                if (!confirmLoad) return;
                
                // Clear current form
                document.getElementById('clientForm').reset();
                
                // Load saved data
                Object.entries(parseData.data).forEach(([key, value]) => {
                    const element = document.querySelector(`[name="${key}"]`);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = true;
                        } else {
                            element.value = value;
                        }
                    }
                });
                
                showProgressStatus(`‚úÖ Progress loaded: ${companyName}`, 'success');
                console.log('Form progress loaded:', parseData);
                
            } catch (error) {
                showProgressStatus('‚ùå Error loading progress', 'error');
                console.error('Load progress error:', error);
            }
        }

        function clearFormProgress() {
            const confirmClear = confirm(
                'Clear saved progress?\\n\\n' +
                'This will delete locally saved form data and reset the current form.\\n\\n' +
                'This action cannot be undone.'
            );
            
            if (confirmClear) {
                localStorage.removeItem('clientFormProgress');
                document.getElementById('clientForm').reset();
                showProgressStatus('üóëÔ∏è Progress cleared', 'warning');
                console.log('Form progress cleared');
            }
        }

        function showProgressStatus(message, type) {
            const statusElement = document.getElementById('progressStatus');
            statusElement.textContent = message;
            statusElement.className = `progress-status ${type}`;
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                statusElement.textContent = '';
                statusElement.className = 'progress-status';
            }, 3000);
        }

        // Check for saved progress on page load
        function checkSavedProgress() {
            const savedData = localStorage.getItem('clientFormProgress');
            if (savedData) {
                try {
                    const parseData = JSON.parse(savedData);
                    const savedDate = new Date(parseData.timestamp);
                    const companyName = parseData.companyName;
                    
                    showProgressStatus(`üíæ Found saved: ${companyName} (${savedDate.toLocaleDateString()})`, 'warning');
                } catch (error) {
                    console.error('Error checking saved progress:', error);
                }
            }
        }

        // Update DOMContentLoaded to include office hours initialization and edit mode check
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== PAGE LOADED ===');
            console.log('Current URL:', window.location.href);
            console.log('URL Search Params:', window.location.search);
            
            // Check for edit mode first
            const isEditMode = checkEditMode();
            console.log('Edit mode detected:', isEditMode);
            
            addService();
            addTechnician(); 
            // Remove the old addServiceArea call since we're replacing it
            initializeOfficeHours();
            initializeStateDropdowns(); // Initialize state dropdowns
            
            // Check for saved progress (only if not in edit mode)
            if (!isEditMode) {
                setTimeout(checkSavedProgress, 500);
                // Set default office hours after a brief delay to ensure elements exist
                setTimeout(setDefaultOfficeHours, 100);
            }
            
            console.log('=== PAGE INITIALIZATION COMPLETE ===');
        });
    </script>
</body>
</html>
